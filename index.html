<!DOCTYPE html>
<html class="telFlasherClass">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="./styles.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Telink Flasher v6.2</title>
<script type="text/javascript" src="./core.js"></script>
</head>
<body>
<script>
//BLE values
var bluetoothDevice, gattServer, Theservice, writeCharacteristic;
var ServiceMain, writeCharacteristicSpeed = null, nitifiyCharTemp, time_char, enc_main, enc_10, enc_19;
//Firmware values
var fwmaxsize = 0x40000;
//var rawurl = "https://raw.githubusercontent.com/devbis/telink-zigbee/main/";
var rawurl = "https://raw.githubusercontent.com/pvvx/ATC_MiThermometer/master/";
var otafiles = { loaded: false, version: 67,
custom:["ATC_ota_40000.bin", "", "", "ATC_ota_40000.bin", "ATC_ota_40000.bin", "ATC_ota_40000.bin", "", "","",""], 
original: [],
//custom:["ATC_v43.bin", "MHO_C401_v43.bin", "CGG1_v43.bin", "ATC_v43.bin", "ATC_v43.bin", "ATC_v43.bin", "CGDK2_v43.bin", "CGG1M_v43.bin","MHO_C401N_v43.bin","BTH_v43.bin"], 
//original:["Original_OTA_Xiaomi_LYWSD03MMC_v1.0.0_0130.bin","Original_OTA_Xiaomi_MHO_C401_v1.0.0_0010.bin","Original_OTA_CGG1_v1.0.1_0093.bin","Original_OTA_Xiaomi_LYWSD03MMC_v1.0.0_0130.bin","Original_OTA_Xiaomi_LYWSD03MMC_v1.0.0_0130.bin","Original_OTA_Xiaomi_LYWSD03MMC_v1.0.0_0130.bin", "Original_OTA_CGDK2_v1.1.1_0217.bin", "Original_OTA_CGG1M_v2.2.1.bin","Original_OTA_Xiaomi_MHO_C401_v1.0.0_0016.bin","Original_OTA_Xiaomi_MJWSD05MMC_v2.0.0_0026.bin"]
};
var firmwareArray = "",
	startTime = 0,
	blockCount = 0;
var flg_memo_act = false;
var devinfo = { hrstr: null, srstr: null, frstr: null };
var fwname = '';
//Connection values
var state = 0,
	connectTrys = 0;
//Custom firmware
var customEnabled, devTest = false;
var settingsCharacteristics = null;
// Custom config
var MAX_RF_TX_Power = false;
var cfg = {enable: false, ver: 0, hver: 0, flg: 0, flg2: 0, temp_offset: 0, humi_offset: 0, advertising_interval: 32, measure_interval: 5, rf_tx_power: 191, connect_latency: 49, lcd_tint: 55, av_meas_mem: 60, step_time: 16000000};
var trg = {enable: false, tmp_thr: 2100, hm_thr: 5000, tmp_hst: -1, hm_hst: 0, flg: 0, rds_type: 0, rds_rpint: 0};
var cmf = {enable: false, tmp_lo: 2100, tmp_hi: 2600, hm_lo: 3000, hm_hi: 6000};
var dnm = {enable: false, name: ""};
var devtime = {};
var pincode = {enable: false, value: 0};
//Mi values
var miEnabled = false,
	otaEnabled = false,
	EnabledQinping = false,
	devInfEnabled = false,
	miConnected = false,
	devIdEnabled = false,
	bigOtaEnabled = true,
	mode_activation;
//Login values
var mi_random_key, mi_random_key_recv, mi_device_info_recv, mi_device_info_send, device_known_id, expected_device_infos, is_logged_in = false;
//Activation values
var keypair, is_activated, own_public_key, device_public_key, shared_key, derived_key, mi_write_did;
var device_new_id = "00626c742e332e31323976" + makeRandomID(6) + "616364"; // 0+"blt.3.129v"+rand[6]+"abc"
var $ = function(id) { return document.getElementById(id);}
function resetVariables() {
	fwmaxsize = 0x40000;
	busy = false;
	gattServer = null;
	Theservice = null;
	mikeys.restore = false;
	mikeys.mac = null;
	mikeys.id = null;
	mikeys.token = null;
	mikeys.bindkey = null
	mikeys.cbindkey = null
	mikeys.cfg = null;
	mikeys.delkeys = null;
	ext.enable = false;
	pincode.enable = false;
	cfg.enable = false;
	trg.enable = false;
	cmf.enable = false;
	dnm.enable = false;
	cnt_buf11 = 0;
	writeCharacteristic = null;
	settingsCharacteristics = null;
	miConnected = false;
	bigOtaEnabled = true;
	is_logged_in = false;
	devinfo.hrstr = null;
	devinfo.srstr = null;
	devinfo.frstr = null;
	//fwname = '';
	devtime = {};
	writeCharacteristicSpeed = null;
	$("ldfrmw").innerHTML ='';
	$("custcfg").innerHTML = '';
	$("tempHumiData").innerHTML = "Temp/Humidity: waiting notify for data after connecting";
	$("percent").innerHTML = "Status: Disconnected";
}

function handleError(error) {
	if (connectTrys == 1000) {
		disconnect();
	} else {
		addLog(error);
		resetVariables();
		if (connectTrys < 5) {
			connectTrys++;
			addLog("Reconnect " + connectTrys + " from " + 5);
			doConnect();
		} else {
			addLog("Something went wrong, too many reconnects");
			connectTrys = 0;
		}
	}
}

function disconnect() {
	if (bluetoothDevice != null) bluetoothDevice.gatt.disconnect();
	$("MAC").innerHTML = '';
	$("ldfile").hidden = true;
	cfg.hver = null;
	hwver_id = null;
	resetVariables();
}

function onDisconnected() {
	addLog('Disconnected.');
	$("MAC").innerHTML = '';
	$("ldfile").hidden = true;
	cfg.hver = null;
	hwver_id = null;
	resetVariables();
}

function connect() {
	var deviceOptions = {
		optionalServices: ['00001f10-0000-1000-8000-00805f9b34fb','00010203-0405-0607-0809-0a0b0c0d1912', 'ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6', '22210000-554a-4546-5542-46534450464d', 0x180a, 0x181c, 0x181e, 0xfe95, 0x1f10, 0x1f11, 0x181a, 0xfff9, 0xfdcd, 0xffe0],
		services: [0x180a, 0x181c, 0x181e, 0xfe95, 0x1f10, 0x1f11, 0x181a, 0xfff9, 0xfdcd, 0xffe0],
		acceptAllDevices: true };
	const namePrefix = $('namePrefix').value;
	if (namePrefix) {
		deviceOptions.acceptAllDevices = false;
		deviceOptions.filters = namePrefix.split(",")
			.map((x) => ({ namePrefix: x }));
	} else {
		deviceOptions.acceptAllDevices = false;
		deviceOptions.filters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz_#@!*0123456789';,.<>{}[]"
			.split("")
			.map((x) => ({ namePrefix: x }));
	}
	addClog(deviceOptions)
	if (bluetoothDevice != null) bluetoothDevice.gatt.disconnect();
	resetVariables();
	addAlog("Searching for devices");
	connectTrys = 0;
	navigator.bluetooth.requestDevice(deviceOptions).then(device => {
		bluetoothDevice = device;
		if($("advmac").checked)
			catchAdvertisement(device);
		bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
		addLog("Connecting to: " + bluetoothDevice.name);
		setStatus("Connecting to: " + bluetoothDevice.name + " ...");
		if(!$("advmac").checked)
				doConnect();
	}).catch(handleError);
}

const tabid2name = [
  { id: 0x01AA, name: "LYWSDCGQ"},
  { id: 0x045B, name: "LYWSD02"},
  { id: 0x055B, name: "LYWSD03MMC"},
  { id: 0x1203, name: "XMWSDJ04MMC"},
  { id: 0x04E1, name: "XMMF01JQD"},
  { id: 0x0098, name: "HHCCJCY01"},
  { id: 0x03BC, name: "GCLS002"},
  { id: 0x015D, name: "HHCCPOT002"},
  { id: 0x040A, name: "WX08ZM"},
  { id: 0x098B, name: "MCCGQ02HL"},
  { id: 0x0083, name: "YM-K1501"},
  { id: 0x0113, name: "YM-K1501EU"},
  { id: 0x045C, name: "V-SK152"},
  { id: 0x0863, name: "SJWS01LM"},
  { id: 0x07F6, name: "MJYD02YL"},
  { id: 0x03DD, name: "MUE4094RT"},
  { id: 0x0A8D, name: "RTCGQ02LM"},
  { id: 0x00DB, name: "MMC-T201-1"},
  { id: 0x0489, name: "M1S-T500"},
  { id: 0x0C3C, name: "CGC1"},
  { id: 0x0576, name: "CGD1"},
  { id: 0x066F, name: "CGDK2"},
  { id: 0x0347, name: "CGG1"},
  { id: 0x0B48, name: "CGG1-ENCRYPTED"},
  { id: 0x03D6, name: "CGH1"},
  { id: 0x0A83, name: "CGPR1"},
  { id: 0x06d3, name: "MHO-C303"},
  { id: 0x0387, name: "MHO-C401"},
  { id: 0x02DF, name: "JQJCY01YM"},
  { id: 0x0997, name: "JTYJGD03MI"},
  { id: 0x1568, name: "K9B-1BTN"},
  { id: 0x1569, name: "K9B-2BTN"},
  { id: 0x0DFD, name: "K9B-3BTN"},
  { id: 0x07BF, name: "YLAI003"},
  { id: 0x0153, name: "YLYK01YL"},
  { id: 0x068E, name: "YLYK01YL-FANCL"},
  { id: 0x04E6, name: "YLYK01YL-VENFAN"},
  { id: 0x03BF, name: "YLYB01YL-BHFRC"},
  { id: 0x03B6, name: "YLKG07YL/YLKG08YL"},
  { id: 0x069E, name: "ZNMS16LM"},
  { id: 0x069F, name: "ZNMS17LM"},
  { id: 0x04E9, name: "MJZNMSQ01YD"},
  { id: 0x098C, name: "XMZNMST02YD"},
  { id: 0x2832, name: "MJWSD05MMC"}
];
function id2name(dev_id) {
	let did = tabid2name.map(el => el.id);
	let i = did.indexOf(dev_id);
	if(i != -1) return tabid2name[i].name;
	return "?";
}
const tabDoor2event = [
  { id: 0, name: "opened"},
  { id: 1, name: "closed"},
  { id: 2, name: "closing timeout"},
  { id: 3, name: "device reset"}
];
function Door2event(id) {
	let did = tabDoor2event.map(el => el.id);
	let i = did.indexOf(id);
	if(i != -1) return tabDoor2event[i].name;
	return "?";
}
const tabHaBle2name = [
  { id: 0, name: "PacketId", unit: "", factor: 1},
  { id: 1, name: "battery", unit: "%", factor: 1},
  { id: 2, name: "temperature", unit: "°C", factor: 0.01},
  { id: 3, name: "humidity", unit: "%", factor: 0.01},
  { id: 4, name: "pressure", unit: "hPa", factor: 0.01},
  { id: 5, name: "illuminance", unit: "lux", factor: 0.01},
  { id: 6, name: "weight", unit: "kg", factor: 0.01},
  { id: 7, name: "weight", unit: "kg", factor: 1},
  { id: 8, name: "dewpoint", unit: "°C", factor: 0.01},
  { id: 9, name: "count", unit: "", factor: 1},
  { id: 10, name: "energy", unit: "kWh", factor: 0.001},
  { id: 11, name: "power", unit: "W", factor: 0.01},
  { id: 12, name: "voltage", unit: "V", factor: 0.001},
  { id: 13, name: "pm2x5", unit: "kg/m3", factor: 1},
  { id: 14, name: "pm10", unit: "kg/m3", factor: 1},
  { id: 15, name: "boolean", unit: "", factor: 1},
  { id: 16, name: "switch", unit: "", factor: 1},
  { id: 17, name: "opened", unit: "", factor: 1}
];

function catchAdvertisement(device) {
  addAlog("Get Advertising MAC (Web Experimental Features!)");
  const abortController = new AbortController();
  device.addEventListener('advertisementreceived', (event) => {
	addClog('Received advertisement from "' + device.name + '"...');
	event.serviceData.forEach((b, key) => {
	const buf = new Uint8Array(b.buffer);
	addClog(buf, device, event);
	let s = 'MAC: ?';
	if(key == '0000fe95-0000-1000-8000-00805f9b34fb') { // mi
		if(b.byteLength >= 2) { // custom mi
			let ctrl = b.getUint16(0, true);
			s = 'MiVer'+ (ctrl>>12);
			let i = 2;
			if((ctrl&0xf000) >= 0x2000 && b.byteLength >= i + 3) {
				let dev_id = b.getUint16(i, true);
				let frcntr = b.getUint8(i+2);
				i += 3;
				s += ', DevID: 0x'+ hex(dev_id, 4);
				s += "-" + id2name(dev_id);
				s += ', FnCnt: '+ frcntr;
				s += ', CtrID: 0x'+ hex(ctrl, 4);
				if(ctrl & 0x100)
					s +=' Registered and bound';
				else
					s +=' Not bound';
				if(ctrl & 0x200)
					s +=', Request APP to register and bind';
				switch((ctrl>>10)&3) {
					case 0:
						s +=', Old version certification';
						break;
					case 1:
						s +=', Safety certification';
						break;
					case 2:
						s +=', Standard certification';
						break;
					//case 3:
					//	s +=' reserved';
					//	break;
				}
				if(ctrl & 0x200)
					s +=', Request APP to register and bind';
				if((ctrl & 0x10) && b.byteLength >= i + 6) {
					s += ', MAC: '+hex(buf[i+5],2)+hex(buf[i+4],2)+hex(buf[i+3],2)+hex(buf[i+2],2)+hex(buf[i+1],2)+hex(buf[i],2);
					i += 6;
				}
				if((ctrl & 0x20) && b.byteLength >= i + 1) {
					let cap = b.getUint8(i);
					i += 1;
					s +=', Capability: 0x'+ hex(cap,2);
					switch((cap>>3) & 3) {
						case 0:
							s +=' - no binding';
							break;
						case 1:
							s +=' - front binding';
							break;
						case 2:
							s +=' - back binding';
							break;
						case 3:
							s +=' - Combo';
							break;
					}
					if(cap & 0x20 && b.byteLength >= i + 2) {
						s +=', IO: 0x'+ hex(b.getUint16(i, true), 4);
						i += 2;
					}
				}
				if((ctrl & 0x40)) {
					if(b.byteLength >= i + 4) {
						if(ctrl & 8) {
								s += ', Data encrypted';
						} else {
							let data_id = b.getUint16(i, true);
							let data_len = b.getUint8(i+2);
							i += 3;
							if(b.byteLength >= i + data_len) switch(data_id) {
								case 0x1006:
									if(data_len == 2) {
										let humi = b.getInt16(i, true) / 10.0;
										s += ', Humi: '+humi+'%';
									}
									break;
								case 0x1004:
									if(data_len == 2) {
										let temp = b.getInt16(i, true) / 10.0;
										s += ', Temp: '+temp+'°C';
									}
									break;
								case 0x100a:
									if(data_len == 1) {
										s += ', Bat: '+ b.getUint8(i) + '%';
										if(b.byteLength >= i + 3 && b.getUint8(i+1) == 2) {
											let Vbat = b.getUint16(i+2, true);
											s += ', Vbat: '+ Vbat + ' mV';
											i += 3;
										}
									}
									break;
								case 0x100d:
									if(data_len == 4 && b.byteLength >= i + 3) {
										let temp = b.getInt16(i, true) / 10.0;
										let humi = b.getInt16(i+2, true) / 10.0;
										s += ', Temp: '+temp+'°C Humi: '+humi+'%';
									}
									break;
								case 0x1019:
									if(data_len == 1) {
										s += ', Door: '+ Door2event(b.getUint8(i));
									}
									break;
								default:
									s += ', DataID: 0x'+hex(data_id,4);
									let data_value = 0;
									if(data_len == 1)
										s += ' Value: 0x'+hex(b.getUint8(i),2);
									else if(data_len == 2)
										s += ' Value: 0x'+hex(b.getUint16(i, true),4);
									else if(data_len == 4)
										s += ' Value: 0x'+hex(b.getUint32(i, true), 8);
									else
										s += ' DataLen: ' + data_len;
									break;
							}
							i += data_len;
						}
					}
				}
				if(ctrl & 0x80)
					s +=', Mesh Data';
			}
		}
	} else if(key == '0000181a-0000-1000-8000-00805f9b34fb') {
		if(b.byteLength >= 15) { // pvvx
			// 70 58 56 38 C1 A4 69 0A 60 09 25 0B 48 70 04
			let temp = b.getInt16(6, true) / 100.0;
			let humi = b.getInt16(8, true) / 100.0;
			let vbat = b.getUint16(10, true);
			let bat = b.getUint8(12);
			let cnt = b.getUint8(13);
			let flg = b.getUint8(14);
			s = 'MAC: '+hex(buf[5],2)+hex(buf[4],2)+hex(buf[3],2)+hex(buf[2],2)+hex(buf[1],2)+hex(buf[0],2);
			s += ', Bat: '+bat+'%, Vbat: '+vbat+' mV , Temp: '+temp+'°C, Humi: '+humi+'%, Count: '+cnt+', Flg: '+flg;
		} else if(b.byteLength == 13) { // atc1441
			// A4 C1 38 56 58 70 01 0A 18 48 0B 25 70
			let temp = b.getInt16(6, false) / 10.0;
			let humi = b.getUint8(8);
			let bat = b.getUint8(9);
			let vbat = b.getUint16(10, false);
			let cnt = b.getUint8(12);
			s = 'MAC: '+hex(buf[0],2)+hex(buf[1],2)+hex(buf[2],2)+hex(buf[3],2)+hex(buf[4],2)+hex(buf[5],2);
			s += ', Bat: '+bat+'%, Vbat: '+vbat+' mV, Temp: '+temp+'°C, Humi: '+humi+'%, Count: '+cnt;
		}
	} else if(key == '0000fff9-0000-1000-8000-00805f9b34fb') { // CGG1 "Goose"
		// 0801 AE1610342D58 0104 1401 4601 0201 58
		if(b.byteLength >= 16 && b.getUint16(0, true) == 0x0108 && b.getUint16(8, true) == 0x0401 && b.getUint16(14, true) == 0x0102) {
			let temp = b.getInt16(10, true) / 10.0;
			let humi = b.getInt16(12, true) / 10.0;
			let bat = b.getUint8(16);
			let s = 'MAC: '+hex(buf[2],2)+hex(buf[3],2)+hex(buf[4],2)+hex(buf[5],2)+hex(buf[6],2)+hex(buf[7],2);
			s += ', Bat: '+bat+'%, Temp: '+temp+'°C, Humi: '+humi+'%';
			log(s);
		}
	} else if(key == '0000fdcd-0000-1000-8000-00805f9b34fb') {	// Qingping / ClearGrass
		// CGPR1 0812 005E60342D58 0201 64 0F01 72 0904 08000000
		//	 0812 005E60342D58 0201 64 0F01 6E 0904 91140000
		//	 4812 005E60342D58 0804 01 911400 0F01 6F
		//		 4812 005E60342D58 1101 01 0F01 85
		//	 4812 005E60342D58 1101 00 0F01 8C
		let msg_length = b.byteLength;
		if(msg_length >= 11 && (b.getUint8(0)&0x3f) == 0x08) {
			let device_id = b.getUint8(1);
			s = 'MAC: '+hex(buf[2],2)+hex(buf[3],2)+hex(buf[4],2)+hex(buf[5],2)+hex(buf[6],2)+hex(buf[7],2);
			if(device_id == 0x01) s+=' CGG1 "Goose"';
			else if (device_id == 0x07) s+=' CGG1';
			else if (device_id == 0x09) s+=' CGP1W';
			else if (device_id == 0x0C) s+=' CGD1';
			else if (device_id == 0x12) s+=' CGPR1';
			//if((b.getUint8(0)&0x40)!=0) s+=', Event';
			let xdata_point = 10;
				while (xdata_point < msg_length) {
				let xdata_id = b.getUint8(xdata_point-2);
				let xdata_size = b.getUint8(xdata_point-1);
				if(xdata_point + xdata_size <= msg_length) {
				 if((xdata_id == 0x01)&&(xdata_size == 4)) {
					let temp = b.getInt16(xdata_point, true) / 10.0;
					let humi = b.getInt16(xdata_point+2, true) / 10.0;
					s += ', Temp: '+temp+'°C, Humi: '+humi+'%';
				 } else if((xdata_id == 0x02)&&(xdata_size == 1)) {
					s += ', Bat: '+b.getUint8(xdata_point)+'%';
				 } else if((xdata_id == 0x07)&&(xdata_size == 2)) {
					s += ', Pressure: '+(b.getInt16(xdata_point, true) / 100.0);
				 } else if((xdata_id == 0x08)&&(xdata_size == 4)) {
					s += ', Motion: '+ b.getUint8(xdata_point)+' & Light: '+(b.getUint16(xdata_point+1, true)+b.getUint8(xdata_point+3)*256);
				 } else if((xdata_id == 0x09)&&(xdata_size == 4)) {
					s += ', Light: '+(b.getUint32(xdata_point, true));
				 } else if((xdata_id == 0x0F)&&(xdata_size == 1)) {
					s += ', Count: '+b.getUint8(xdata_point);
				 } else if((xdata_id == 0x11)&&(xdata_size == 1)) {
					if(b.getUint8(xdata_point) == 0) s += ', Light Off';
					else s += ', Light On';
				 } else if (xdata_size == 1) {
					s += ', id: 0x'+hex(xdata_id,2)+' - data: 0x'+hex(buf[xdata_point],2);
				 } else if (xdata_size == 2) {
					s += ', id: 0x'+hex(xdata_id,2)+' - data: 0x'+hex(buf[xdata_point],2)+hex(buf[xdata_point+1],2);
				 } else if (xdata_size == 4) {
					s += ', id: 0x'+hex(xdata_id,2)+' - data: 0x'+hex(buf[xdata_point],2)+hex(buf[xdata_point+1],2)+hex(buf[xdata_point+2],2)+hex(buf[xdata_point+3],2);
				 }
				} else break;
				xdata_point = xdata_point + xdata_size + 2;
			}
		}
	} else if(key == '00001f11-0000-1000-8000-00805f9b34fb') {	// AdScanerTrg
		if(b.byteLength > 10) {
			let temp = b.getInt16(0, true) / 100.0; // temp
			let humi = b.getInt16(2, true)	/ 100.0; // humi
			let lumi = b.getInt16(4, true); // light
			let mtimer = b.getUint16(6, true)
			let motion = b.getUint8(8);
			let jlight = b.getUint8(9);
			let flg = b.getUint8(10);
			s = ("AdScanerTrg# Temp: "+temp.toFixed(2)+
			", Humi: "+humi.toFixed(2)+
			", Lumi: " +lumi.toFixed(0)+
			", MTimer: " +mtimer+
			", HiMotion: " +motion+
			", JLight: "+jlight+
			", Flg: 0x"+hex(flg,2)+
			" # ReedSwitchOut: "+(flg&1)+
			", TempHumiOut: "+((flg>>1)&1)+
			", LightMotionOut: "+((flg>>2)&1)+
			", TempEvent: "+((flg>>3)&1)+
			", HumiEvent: "+((flg>>4)&1)+
			", LightEvent: "+((flg>>5)&1));
		}
	} else if(key == '0000181c-0000-1000-8000-00805f9b34fb') {	// BTHome
		if(b.byteLength > 1) {
			s += " BTHomeV1";
			let len = b.byteLength;
			let i = 0;
			while(i < len) {
				let sl = b.getUint8(i)&31; // size
				if(i+sl+1 > len) break;
				let st = b.getUint8(i)>>5;
				if(sl > 0) {
					let dd = b.getUint8(i+1);
					let value = 0;
					let did = tabHaBle2name.map(el => el.id);
					let e = did.indexOf(dd);
					let f = 1;
					if(e != -1) f = tabHaBle2name[e].factor;
					if(st == 0) {
						if(sl == 2)
							value = b.getUint8(i+2);
						else if(sl == 3)
							value = b.getUint16(i+2, true);
						else if(sl == 4)
							value = b.getUint16(i+2, true) + (b.getUint8(i+4)<<16);
						else if(sl == 5)
							value = b.getUint32(i+2, true);
						if(f != 1)	value = (value*f).toFixed(3);
					} else if(st == 1) {
						if(sl == 2)
							value = b.getInt8(i+2);
						else if(sl == 3)
							value = b.getInt16(i+2, true);
						else if(sl == 4) {
							value = b.getUint16(i+2, true) | (b.getInt8(i+4)<<16);
						} else if(sl == 5)
							value = b.getInt32(i+2, true);
						if(f != 1)	value = (value*f).toFixed(3);
					} else
						value = "?";
					if(e != -1) {
						s += ', '+tabHaBle2name[e].name+': '+value+tabHaBle2name[e].unit;
					} else
						s += ', '+st+'?: '+value;
				}
				i += sl+1;
			}
		}
	} else if(key == '0000181e-0000-1000-8000-00805f9b34fb') {	// BTHome
		s += " BTHomeV1, Data encrypted";
	}
	addAlog(s);
	abortController.abort();
	doConnect();
	})
  }, { once: true });
  addClog('Catching advertisement from "' + device.name + '"...');
  device.watchAdvertisements({ signal: abortController.signal })
  .catch(error => {
	addClog('Error: ' + error);
  });
}
var cusService, cus017Chr, cus018Chr, cus100Chr;
function sendCmdClear() {
	cus017Chr.writeValue(new Uint8Array([0x01,0x0e]))
	.then(() => { disconnect(); });
}
function getMTimer() {
	cus017Chr.writeValue(new Uint8Array([0x01,0x13]));
}
function setMTimer() {
	let t = parseInt($("mtimer").value);
	if(t > 100) {
		cus017Chr.writeValue(new Uint8Array([0x05,0x10,t&0xff,(t>>8)&0xff,(t>>16)&0xff,(t>>24)&0xff]))
		.then(() => { cus017Chr.writeValue(new Uint8Array([0x01,0x13])); });
	}
}
function CustomQingpingParse(value) {
	//let value = event.target.value;
	let cid = value.getUint16(0, true);
	if(cid == 0x1706) {
		let temp = value.getInt16(2, true)/10;
		let humi = value.getInt16(4, true)/10;
		let s = "Temp: "+temp+"C, Humi: "+humi+"%";
		$("tempHumiData").innerHTML = '<hr>'+s;
		addClog(s);
	} else if(cid == 0x0202) {
		addLog("Battery: "+ value.getUint8(2) + "%");
	} else if(cid == 0x0305) {
		let mt = value.getUint8(2);
		let lx = value.getUint16(3, true) + (value.getUint8(5) << 16);
		let tempString = "MotionT: " + mt + ", Illumination: "+ lx + " lx";
		$("tempHumiData").innerHTML = '<hr>'+tempString;
		addClog(tempString);
	} else
		addClog("CustNotify100: "+bytesToHex(event.target.value.buffer));
}

function CGPR1_Action() {
	addLog("Detected Qingping CGPR1 device");
	$("custcfg").innerHTML = '<hr>When doing an activation here the device is needed to be activated in the Mi app again when wanted to use there.<br>Press and hold the button on the back of CGG1-M for 2 seconds until the Bluetooth icon starts blinking on the e-ink display, and then click the "Connect" and "Do Activation" buttons on the TeLink Flasher.<br><button type="button" onclick="sendRegister();">Do Activation</button> <button type="button" onclick="skipActivation();">Skip Activation</button>	 <button type="button" onclick="keyMiLogin();">Login</button><br>Device known id:<br><input size="40" type="text" id="known_id" value=""><br>Mi Token:<br><input size="40" type="text" id="mi_token" value=""><br>Mi Bind Key:<br><input size="40" type="text" id="mi_bind_key" value=""><br><br><button type="button" onclick="sendCmdClear();">Clear all settings and reset device (into Qingping mode)</button><br><br>MTimer: <input type="text" id="mtimer" value="?"> ms <button type="button" onclick="getMTimer();">Get</button> <button type="button" onclick="setMTimer();">Set</button><br>';
	gattServer.getPrimaryService("22210000-554a-4546-5542-46534450464d")
		.then(service => {
			addClog("Found Custom service");
			cusService = service;
			return cusService.getCharacteristic(0x0017);
		}).then(characteristic => {
			cus017Chr = characteristic;
			addClog('Found 0x0017 characteristic');
			return cusService.getCharacteristic(0x0018);
		}).then(characteristic => {
			cus018Chr = characteristic;
			addClog('Found 0x0018 characteristic');
			return cus018Chr.addEventListener('characteristicvaluechanged', event => {
				let value = event.target.value;
				addClog("CustNotify018: " + bytesToHex(event.target.value.buffer));
				let cid = value.getUint16(0, true);
				if(cid == 0x0202) {
						addLog("Battery: "+ value.getUint8(2) + "%");
				} else if(cid == 0x0405) {
					let adc = value.getUint32(2, true);
					addLog("Level: " + adc);
				} else if(cid == 0x0305) {
					let mt = value.getUint8(2);
					let lx = value.getUint16(3, true) + (value.getUint8(5) << 16);
					addLog("Event: " + mt + ", Illumination: "+ lx + " lx");
				} else if(cid == 0x1305) {
					let tm = value.getUint32(2, true);
					addLog("Timer: "+ tm + " ms (" + (tm/1000) + " sec)");
					$("mtimer").value = tm.toString(10);
				} else if(cid == 0xff04) {
					let cmd = value.getUint8(2);
					let err = value.getUint8(3);
					if(err == 0) {
						if(cmd == 0x10)	addLog("Set timer - ok");
						else if(cmd == 0x0e) addLog("Clear - ok (Mode Qingping)");
						else addLog("Command " + cmd.toString(16) + " - ok");
					} else addLog("Command " + cmd.toString(16) + " - Error " + err.toString(16));
				} else
					addLog("CustNotify018: " + bytesToHex(event.target.value.buffer));
			});
		}).then(_ => {
			return cus018Chr.startNotifications();
		}).then(_ => {
			return cusService.getCharacteristic(0x0100);
		}).then(characteristic => {
			cus100Chr = characteristic;
			addClog('Found 0x0100 characteristic');
			return cus100Chr.startNotifications().then(() => {
				cus100Chr.addEventListener('characteristicvaluechanged', event => CustomQingpingParse(event.target.value));
				cus017Chr.writeValue(new Uint8Array([0x01,0x02]))
					.then(() => { cus017Chr.writeValue(new Uint8Array([0x01,0x13])); });
				miAuthorization();
			});
		}).catch(handleError);
}
function CGDK2_Action() {
	cus017Chr = null;
	addLog("Detected Qingping CGDK2 device");
	//if(devinfo.frstr && devinfo.frstr.substr(0,5) == "2.2.3") addAlog("Warning! The device with this Firmware Revision is not supported!");	
	$("custcfg").innerHTML = '<hr>When doing an activation here the device is needed to be activated in the Mi app again when wanted to use there.<br><button type="button" onclick="sendRegister();">Do Activation</button> <button type="button" onclick="keyMiLogin();">Login</button><br>Device known id:<br><input size="40" type="text" id="known_id" value=""><br>Mi Token:<br><input size="40" type="text" id="mi_token" value=""><br>Mi Bind Key:<br><input size="40" type="text" id="mi_bind_key" value="">';
	gattServer.getPrimaryService("22210000-554a-4546-5542-46534450464d")
		.then(service => {
			addClog("Found Custom service");
			cusService = service;
			return cusService.getCharacteristic(0x0100);
		}).then(characteristic => {
			cus100Chr = characteristic;
			addClog('Found 0x0100 characteristic');
			return cus100Chr.startNotifications().then(() => {
				cus100Chr.addEventListener('characteristicvaluechanged',
					event => CustomQingpingParse(event.target.value));
				miAuthorization();
			});
		}).catch(handleError);
}
function CGG1_Action(model) {
	cus017Chr = null;
	addLog("Detected Qingping CGG1 device " + model);
	$("custcfg").innerHTML = '<hr>When doing an activation here the device is needed to be activated in the Mi app again when wanted to use there.<br>Press and hold the button on the back of CGG1-M for 2 seconds until the Bluetooth icon starts blinking on the e-ink display, and then click the "Connect" and "Do Activation" buttons.<br><button type="button" onclick="sendRegister();">Do Activation</button>	<button type="button" onclick="keyMiLogin();">Login</button><br>Device known id:<br><input size="40" type="text" id="known_id" value=""><br>Mi Token:<br><input size="40" type="text" id="mi_token" value=""><br>Mi Bind Key:<br><input size="40" type="text" id="mi_bind_key" value=""><br><br>';
	gattServer.getPrimaryService("22210000-554a-4546-5542-46534450464d")
		.then(service => {
			addClog("Found Custom service");
			cusService = service;
			return cusService.getCharacteristic(0x0100);
		}).then(characteristic => {
			cus100Chr = characteristic;
			addClog('Found 0x0100 characteristic');
			return cus100Chr.startNotifications().then(() => {
				cus100Chr.addEventListener('characteristicvaluechanged',
					event => CustomQingpingParse(event.target.value));
				miAuthorization();
			});
		}).catch(handleError);
}
//var micharacteristics;
function miAction() {
	writeCharacteristicSpeed = null;
	gattServer.getPrimaryService('ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6')
		.then(service => {
			addClog("Found MiMain service");
			ServiceMain = service;
			addClog("Check micharacteristics:");
			return ServiceMain.getCharacteristics();
		}).then(characteristics => {
			//micharacteristics = characteristics;
			for (let i = 0; i < characteristics.length; i++) {
				addClog(characteristics[i].uuid);
				if (characteristics[i].uuid == "ebe0ccd8-7a0a-4b0c-8a1a-6ff2997da3a6") {
					ServiceMain.getCharacteristic(characteristics[i].uuid).then (characteristic =>
					{ addClog("Found MiSet characteristic Speed");
					 writeCharacteristicSpeed = characteristic; });
				}
				else if (characteristics[i].uuid == "ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6") {
					ServiceMain.getCharacteristic(characteristics[i].uuid).then ( characteristic =>
					{ addClog('Found MiTemp characteristic');
						nitifiyCharTemp = characteristic;
						return nitifiyCharTemp.startNotifications().then(() => {
							nitifiyCharTemp.addEventListener('characteristicvaluechanged', event => {
							let value = event.target.value;
							let temp = value.getInt16(0, true) / 100;
							let hum = value.getUint8(2);
							let vbat = value.getUint16(3,true);
							let tempTempString = "Temp: " + temp + "°C, Humi: " + hum + "%, "+vbat+" mV";
							$("tempHumiData").innerHTML = '<hr>'+tempTempString;
							addClog(tempTempString); });
						});
					});
				}
			}
			miAuthorization()
		}).catch(handleError);
}
var buf11;
var cnt_buf11 = 0;
var cnt_delkeys = 0;
var id_buf11 = 0x1000;
var mikeys = {mac: null, id: null, token: null, bindkey: null, cfg: null, delkeys: null, restore: false, cbindkey: null};
var ext = {big_number: 0, small_number: 0, vtime: 60, flg: 0xc7, enable: false};

function concatUint8ArrayArrays(a, b) { // a, b TypedArray of same type
	let c = new Uint8Array(a.byteLength + b.byteLength);
	c.set(a, 0);
	c.set(b, a.byteLength);
	return c;
}
function dump(ar, len) {
	let s = '';
	for(let i=0; i < len; i++) {
		s += hex(ar[i],2);
	}
	return s;
}
var atc_mac, atc_rmac;
function CustomBlkParse(value) {
	let len = value.byteLength;
	let s = '';
	if(len == 0) return;
	len--;	// size from cmd
	let blkid = value.getUint8(0);
	if(devTest) {
		s = 'Custom (0xffe1) Notifications id: 0x'+hex(blkid,2)+' ['+bytesToHex(value.buffer.slice(1))+']';
		addAlog(s);
		return;
	}
	if(blkid == 0x55 && len >= 9) {
		cfg.ver = value.getUint8(1);
		cfg.flg = value.getUint8(2);
		cfg.flg2 = value.getUint8(3);
		cfg.temp_offset = value.getInt8(4);
		cfg.humi_offset = value.getInt8(5);
		cfg.advertising_interval = value.getUint8(6);
		cfg.measure_interval = value.getUint8(7);
		cfg.rf_tx_power = value.getUint8(8);
		if((cfg.rf_tx_power &0x80)==0) MAX_RF_TX_Power=true;
		cfg.connect_latency = value.getUint8(9);
		if(len >= 10) cfg.lcd_tint = value.getUint8(10);
		else cfg.lcd_tint = 55;
		if(len >= 11) {
			cfg.hver = value.getUint8(11);
			if(cfg.ver < 0x36) cfg.hver &= 0x87;
		} else if(cfg.hver == null) cfg.hver = 0x80;
		if(len >= 12) cfg.av_meas_mem = value.getUint8(12); else cfg.av_meas_mem = 0;
		let s = 'Hardware Version: ';
		hwver_id = cfg.hver & 0x0F;
		if((hwver_id == 0)||(hwver_id == 3)||(hwver_id == 4)||(hwver_id == 5)||(hwver_id == 10)) s +='LYWSD03MMC';
		else if(hwver_id == 1) s +='MHO-C401';
		else if(hwver_id == 2) s +='CGG1';
		else if(hwver_id == 6) s +='CGDK2';
		else if(hwver_id == 7) s +='CGG1-M';
		else if(hwver_id == 8) s +='MHO-C401N';
		else if(hwver_id == 9) { s +='MJWSD05MMC'; bigOtaEnabled = true; }
		else if(hwver_id == 11) { s +='MHO-C122'; bigOtaEnabled = true; }
		else s += 'Unknown'
		if(devinfo.hrstr) s += ' ' + devinfo.hrstr;
		s += ', Software Version: '+(cfg.ver>>4)+'.'+(cfg.ver&0x0f);
		setStatus(s);
		if(cfg.ver > 0x33) {
			if((cfg.hver & 0x80) == 0) s += ', Sensor: SHT4x';
			else s += ', Sensor: SHTC3 (SHTV3)';
		}
		addAlog(s);
		addAlog('Custom config HEX string: 55' + bytesToHex(value.buffer.slice(2)));
		if(cfg.ver >= 5) CustomConfig();
		else addLog('Old version - out of service!');
	} else if(blkid == 0x33 && len >= 8) {
		let vbat = value.getUint16(1, true);
		let temp = value.getInt16(3, true) / 100.0;
		let humi = value.getInt16(5, true) / 100.0;
		let count = value.getUint16(7, true);
		let flg = 0;
		let rds_count = 0;
		if(len > 8) {
			flg = value.getUint8(9);
			if(len > 12)
				rds_count = value.getUint32(10, true);
		}
		let s = '';
		if(cfg.ver >= 0x37)
			s = 'Vbat: '+vbat+' mV , Temp: '+temp.toFixed(2)+'°C, Humi: '+humi.toFixed(2)+'%, ID: '+count+', Reed switch counter: '+ rds_count+', flg: 0x'+hex(flg,2)+':r'+(flg&1)+'/t'+((flg>>1)&1);
		else
			s = 'Vbat: '+vbat+' mV , Temp: '+temp.toFixed(2)+'°C, Humi: '+humi.toFixed(2)+'%, ID: '+count+', flg: 0x'+hex(flg,2)+':r'+(flg&1)+'/t'+((flg>>1)&1);
		$("tempHumiData").innerHTML = s;
		addClog(s);
	} else if(blkid == 0x22 && len >= 7) {
		if(hwver_id == 9) {
			ext.big_number = value.getInt32(1, true); // -9950..199950, x0.01
			ext.small_number = 0;
		} else {
			ext.big_number = value.getInt16(1, true); // -995..19995, x0.1
			ext.small_number = value.getInt16(3, true); // -9..99, x1
		}
		ext.vtime = value.getUint16(5, true); // in sec
		ext.flg = value.getUint8(7);
		s = 'ExtShow: big_number: '+ext.big_number+', small_number: '+ext.small_number+', ext.vtime: '+ext.vtime+' s, flg: '+hex(ext.flg,2);
		addAlog(s); UpdExt();
	} else if(blkid == 0x44 && len >= 7) {
		trg.tmp_thr = value.getInt16(1, true) / 100.0; // temp threshold
		trg.hm_thr = value.getInt16(3, true) / 100.0; // humi threshold
		trg.rds_type = 0;
		trg.rds_rpint = 0;
		if(len >= 9) {
			trg.tmp_hst = value.getInt16(5, true) / 100.0;		  // temp hysteresis
			trg.hm_hst = value.getInt16(7, true) / 100.0;		 // humi hysteresis
			if((len >= 12) && (cfg.ver >= 0x37)) {
				trg.rds_rpint = value.getUint16(9, true);
				trg.rds_type = value.getUint8(11);
				trg.flg = value.getUint8(12);
			} else
				trg.flg = value.getUint8(9);
		} else {
			trg.tmp_hst = value.getInt8(5) / 10.0;		  // temp hysteresis
			trg.hm_hst = value.getInt8(6) / 10.0;		 // humi hysteresis
			trg.flg = value.getInt8(7);
		}
		let s = '';
		if(cfg.ver >= 0x37)
			s = 'Threshold Temp/Humi: '+trg.tmp_thr.toFixed(2)+'°C/'+trg.hm_thr.toFixed(2)+'%, Hysteresis T/H: '+trg.tmp_hst.toFixed(2)+'°/'+trg.hm_hst.toFixed(2)+'%, Reed switch mode: '+trg.rds_type+', Rs rep.interval: '+trg.rds_rpint+' sec, flg: 0x'+hex(trg.flg,2);
		else
			s = 'Threshold Temp/Humi: '+trg.tmp_thr.toFixed(2)+'°C/'+trg.hm_thr.toFixed(2)+'%, Hysteresis T/H: '+trg.tmp_hst.toFixed(2)+'°/'+trg.hm_hst.toFixed(2)+'%, flg: 0x'+hex(trg.flg,2);
		if((cfg.ver >= 0x39)&&((trg.rds_type&0x10)!=0)) s += ', RS input inversion'
		addAlog(s); UpdTrg();
	} else if(blkid >= 0x10 && blkid <= 0x14 && len >= 1) {
		let lb = value.getUint8(1);
		if(lb != 0) {
			len -= 1;
			if(cnt_buf11 == 0){
				// addClog('New miKey length: '+lb);
				buf11 = new Uint8Array(lb);
			}
			for(let i = 0; i < len && i < lb; i++ )
				buf11[cnt_buf11++] = value.getUint8(i+2);
			if(len == lb) {
				if(cnt_buf11 == buf11.length) {
					s = '';
					if(blkid == 0x14)  {
						if(cnt_delkeys == 0) {
							mikeys.delkeys = [];
						}
						s = 'Marked as delete Key'+cnt_delkeys+': ';
						cnt_delkeys += 1;
						mikeys.delkeys.push(buf11);
					}
					if(cnt_buf11 == 28) {
						s +=  'miToken: '+dump(buf11.slice(0, 12), 12)+', miBindKey: '+dump(buf11.slice(12), 16);
						if(blkid == 0x12) {
							cnt_delkeys = 0;
							mikeys.token = buf11.slice(0, 12);
							mikeys.bindkey = buf11.slice(12);
							CustomConfig();
						} else if(blkid == 0x14) {
							if(mikeys.token) mikeys.restore = true;
						}
						addLog(s);
					} else if(cnt_buf11 == 20) {
						let str = new TextDecoder("utf-8").decode(buf11.slice(1));
						s += 'miDevId: "'+str+'" '+dump(buf11.slice(1), 19);
						if(blkid == 0x11) {
							cnt_delkeys = 0;
							mikeys.id = buf11;
						}
						addLog(s);
					} else if(cnt_buf11 == 8) {
						// * public_mac:		[0][1][2][3][4][5], const: [3]=38;[4]=C1;[5]=A4
						// * random_static_mac: [0][1][2][6][7]C0
						s += 'MAC: '+hex(buf11[5],2)+hex(buf11[4],2)+hex(buf11[3],2)+hex(buf11[2],2)+hex(buf11[1],2)+hex(buf11[0],2)+', RandMAC: '+'C0'+hex(buf11[7],2)+hex(buf11[6],2)+hex(buf11[2],2)+hex(buf11[1],2)+hex(buf11[0],2);
						if(blkid == 0x10) {
							cnt_delkeys = 0;
							mikeys.mac = buf11;
							addLog(s);
						}
					} else if(cnt_buf11 == 4) {
						s += 'miCfg: '+dump(buf11, 4);
						if(blkid == 0x13) {
							cnt_delkeys = 0;
							mikeys.cfg = buf11;
							addLog(s);
						}
					} else
						s += 'miKey: '+dump(buf11, cnt_buf11);
					addClog(s);
				}
				cnt_buf11 = 0;
			}
		} else if(cnt_buf11 != 0) {
			cnt_buf11 = 0;
			addClog("Error read mi keys!");
		} else {
			if(blkid == 0x11) addAlog('No miDevId!');
			else if(blkid == 0x12) addAlog('No miToken and miBindKey!');
			else if(blkid == 0x13) addAlog('No miCFG!');
			else if(blkid == 0x14) {addClog("End keys"); CustomConfig();}
			else addClog("End keys");
			cnt_buf11 = 0;
		}
	} else if(blkid == 0x18 && len >= 1) { // Get/set beacon bkey in EEP
		if(len >= 16) {
			mikeys.cbindkey = value.buffer.slice(1);
			let s = bytesToHex(mikeys.cbindkey,16);
			addAlog("Read bindkey: "+ s);
			if($("cbind_key"))
				$("cbind_key").value = s;
		} else {
			if(len == 1 && value.getUint8(1) == 0xff)
				addAlog("No bindkey in EEP!");
			else
				addAlog("Error read bindkey from EEP!");
			if($("cbind_key"))
				$("cbind_key").value = '?';
		}
	} else if(blkid == 0x60 && len >= 6) {
		s = 'LCD data: '+bytesToHex(value.buffer.slice(1));
		addAlog(s);
	} else if(blkid == 0x61 && len >= 1) {
		let s = 'LCD flg: '+hex(value.getUint8(1), 2);
		addClog(s);
	} else if(blkid == 0x35) {
		if(flg_memo_act) {
			if(len >= 12) {
				let cnt = value.getUint16(1, true);
				let tc = value.getUint32(3, true);
				let tm = value.getInt16(7, true) / 100.0;
				let hm = value.getUint16(9, true) / 100.0;
				let vb = value.getUint16(11, true);
				let dt = new Date(tc*1000);
				addAlog(((dt.toISOString().slice(0, -1)).replace('T',' ')).replace('.000','')+' # Vbat: '+vb+' mV , Temp: '+tm+'°C, Humi: '+hm+'%, Count: '+cnt);
			} else if(len >= 2) {
				let cnt = value.getUint16(1, true);
				addAlog('Memo end: '+cnt);
				flg_memo_act = false;
			}
		}
	} else if(blkid == 0x23 && len >= 4) {
		devtime.cur = value.getUint32(1,true);
		addClog('Device Time: 0x' + hex(devtime.cur,8));
		let dt = new Date(devtime.cur*1000);
		addAlog('Device Date: '+(dt.toISOString().slice(0, -1)).replace('T',' '));
		if(len >= 8) {
			devtime.set = value.getUint32(5,true);
			addClog('Last clock setting Time: 0x' + hex(devtime.set,8));
			if(devtime.step == 1) {
				if(devtime.set > 0x60000000) {
					devtime.period = devtime.cur - devtime.set;
					let time = Date.now()/1000;
					time -= (new Date()).getTimezoneOffset() * 60;
					devtime.cmp = time;
					let odt = new Date(devtime.set*1000);
					addAlog('Last clock setting: '+(odt.toISOString().slice(0, -1)).replace('T',' '));
					addAlog('DevPeriod: ' + devtime.period.toFixed(1) + ' sec');
					let rp = devtime.cmp - devtime.set;
					let delta = rp - devtime.period;
					addClog('RealPeriod: ' + rp.toFixed(1) + ' sec, Delta: ' + delta.toFixed(1) + ' sec');
					if(rp >= 10800) { // 10800
						devtime.step = 2;
						addClog("Send cmd Get StepTimeSec...");
						settingsCharacteristics.writeValue(new Uint8Array([0x24])).then(_ => {
							addAlog('Get StepTimeSec...');
						});
					} else {
						devtime.step = 0;
						addAlog('The minimum period for calculation is 3 hours!');
					}

				} else {
					devtime.step = 0;
					addAlog('The clock must be set beforehand!');
				}
			}
		}
	} else if(blkid == 0x24 && len >= 4) {
		cfg.step_time = value.getUint32(1,true);
		addClog('step_time: ' + cfg.step_time);
		addAlog('Device StepTimeSec: ' + (cfg.step_time / 16.0).toFixed(3) + ' us');
		if($("cfg_time_step") && cfg.ver >= 0x24) {
			if(devtime.step == 2) {
						devtime.step = 0;
				let rp = devtime.cmp - devtime.set;
				let k = devtime.period/rp;
				addClog('koef: ' + k);
				let nstep_time = cfg.step_time * k;
				$("cfg_time_step").value = nstep_time - 16000000;
				addClog('step_time: ' + nstep_time.toFixed(1));
			} else
				$("cfg_time_step").value = cfg.step_time - 16000000;
		}
	} else if(blkid == 0x20 && len >= 8) {
		cmf.tmp_lo = value.getInt16(1, true); // temp lo
		cmf.tmp_hi = value.getInt16(3, true); // temp hi
		cmf.hm_lo = value.getUint16(5, true); // humi lo
		cmf.hm_hi = value.getUint16(7, true); // humi lo
		let s = 'Comfort Temp: '+(cmf.tmp_lo/100.0).toFixed(2)+'..'+(cmf.tmp_hi/100.0).toFixed(2)+'°C, Humi: '+(cmf.hm_lo/100.0).toFixed(2)+'..'+(cmf.hm_hi/100.0).toFixed(2)+'%';
		addAlog(s); UpdCmf();
	} else if(blkid == 0x73 && len >= 9) {
		let e = value.getUint8(1);
		let faddr = value.getUint32(2, true);
		let fszk = value.getUint32(6, true); // in kbytes
		let s = 'OTA region: 0x'+hex(faddr,6)+', size: '+fszk+' kbytes';
		if(e == 1) s += ' -> OTA works';
		else if(e == 2) s += ' -> Ext.OTA busy';
		else if(e == 3) s += ' -> Ext.OTA ready';
		else if(e == 4) s += ' -> Ext.OTA event';
		else if(e > 0x80) s += ' -> Ext.OTA error';
		else e += ' ('+e+')';
		addClog(s);
		if(e == 4) {
			s = 'Erase the Flash sector at: 0x'+hex(faddr,6)+'...';
			setStatus(s);
			addClog(s);
		} else if(e == 3) {
			s = 'Clean Flash OTA region: 0x'+hex(faddr,6)+', size: '+fszk+' kbytes. Go OTA...';
			setStatus(s);
			addLog(s);
			fwmaxsize = fszk << 10;
			if(bigOtaEnabled) setTimeout(updateBegin(), 1000);
		} else	addClog(s);
	} else if(blkid == 0x01 && len >= 1) {
		dnm.name = new TextDecoder("utf-8").decode(value.buffer.slice(1));
		if($("dev_name"))
			$("dev_name").value = dnm.name;
		addAlog("DevName: ["+dnm.name+"]");
	} else if(blkid == 0x02 && len > 1) {
		let addr = value.getUint8(1);
		s = 'Sensor: ';
		if(addr != 0)
			s += 'I2C addres 0x'+hex(addr >> 1,2);
		else
			s += 'None!';
		s += ', LCD driver: ';
		addr = value.getUint8(2);
		if(addr != 0)
			s += 'I2C addres 0x'+hex(addr >> 1,2);
		else
			s += 'SPI or UART';
		if(len > 2) {
			addr = value.getUint8(3);
			s += ', RTC: ';
			if(addr != 0)
				s += 'I2C addres 0x'+hex(addr >> 1,2);
			else
				s += 'Unknown';
		}
		addAlog(s);
	} else if(blkid == 0x04 && len > 0) {
		let wr = value.getUint8(1);
		if(len == 1)
				s = 'I2C Read/Write fault! ('+wr+')';
		else {
			let addr = value.getUint8(2);
			s = 'I2C addres 0x'+hex(addr,2);
			if(wr != 0)
				s += ', write '+wr+' bytes';
			if(len > 2)
				s += ', read: '+bytesToHex(value.buffer.slice(3));
		}
		addAlog(s);
	} else if(blkid == 0x05 && len > 3) {
		addAlog('Sensor ID: ' + hex(value.getUint32(1,true),8));
	} else {
		let s = 'Custom (0x1f1f) Notifications id: 0x'+hex(blkid,2)+' ['+bytesToHex(value.buffer.slice(1))+']';
		addClog(s);
	}
}

function customAction() {
	gattServer.getPrimaryService('00001f10-0000-1000-8000-00805f9b34fb').then(service => {
		addClog("Found custom Main service (0x1f10)");
		ServiceMain = service;
		return ServiceMain.getCharacteristic('00001f1f-0000-1000-8000-00805f9b34fb');
	}).then(characteristic => {
		settingsCharacteristics = characteristic;
		addClog("Found custom read-write characteristic (0x1f1f)");
		if(devIdEnabled) {
			addClog("Start Notifications (0x1f1f)");
			settingsCharacteristics.startNotifications()
			.then(characteristic => {
				addClog("Add EventListener (0x1f1f)");
				settingsCharacteristics.addEventListener('characteristicvaluechanged', event => CustomBlkParse(event.target.value));
				addClog("Read Characteristics (0x1f1f)");
				settingsCharacteristics.readValue()
				.then(value => {
					$("ldfile").hidden = false;
					addClog("Send cmd (3303): Query 3 measurements");
					settingsCharacteristics.writeValue(new Uint8Array([0x33,0x03]))
					.then(_ => {addClog('Send cmd ok');})
					.catch(error => addClog(error));
				}).catch(error => { addClog(error);
					addLog("Detected alternative Firmware? Use: https://pvvx.github.io/ATC_MiThermometer/TelinkOTA.html");
					setStatus('Detected alternative Firmware? <a href="https://pvvx.github.io/ATC_MiThermometer/TelinkOTA.html">TelinkOTA</a>');
				});
			}).catch(error => addClog(error));
		} else {
			addLog("Detected alternative Firmware? Use: https://pvvx.github.io/ATC_MiThermometer/TelinkOTA.html");
			setStatus('Detected alternative Firmware? <a href="https://pvvx.github.io/ATC_MiThermometer/TelinkOTA.html">TelinkOTA</a>');
			}
	}).catch(handleError);
}

function getTestCharacteristic() {
	gattServer.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb').then(service => {
		addClog("Found custom Main service (0xffe0)");
		ServiceMain = service;
		return ServiceMain.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
	}).then(characteristic => {
		settingsCharacteristics = characteristic;
		addClog("Found custom read-write characteristic (0xffe1)");
		addClog("Start Notifications (0xffe1)");
		settingsCharacteristics.startNotifications().then(characteristic => {
			addClog("Add EventListener (0xffe1)");
			settingsCharacteristics.addEventListener('characteristicvaluechanged', event => CustomBlkParse(event.target.value));
			addLog("Detected alternative Firmware? Use: https://pvvx.github.io/ATC_MiThermometer/TelinkOTA.html");
			setStatus('Detected alternative Firmware? <a href="https://pvvx.github.io/ATC_MiThermometer/TelinkOTA.html">TelinkOTA</a>');
		});
	}).catch(handleError);
}

function menuUpgrade() {
	let is = "";
	$("ldfile").hidden = false;
	if(otafiles.loaded && otafiles.version && hwver_id != null) {
		if(otafiles.custom != null) {
			let f1 = otafiles.custom[hwver_id];
			if(f1 != "" && f1 != "?")
				is += '<button type="button" id="firmupg" onclick="FirmwareUpgrade();">Custom Firmware ver '+(otafiles.version>>4)+'.'+(otafiles.version&0x0f)+'</button>';
		}
		if(otafiles.betafw && otafiles.betaver != null) {
			let f2 = otafiles.betafw[hwver_id];
			if(f2 != "" && f2 != "?")
				is += ' <button type="button" id="btfrmupg" onclick="BetaFirmwareUpgrade();">Beta Firmware ver '+(otafiles.betaver>>4)+'.'+(otafiles.betaver&0x0f)+'</button><br>';
		}
		if(otafiles.original != null) {
			let f3 = otafiles.original[hwver_id];
			if(f3 != "" && f3 != "?")
				is +=' <button type="button" id="btorupg" onclick="BackToOriginal();">' + otafiles.original[hwver_id] +'</button>';
		}
	}
	if(fwname != "" && firmwareArray != "") {
		if(is != "") is += '<br>';
		is += '<button type="button" onclick="startDFU();">Start Flashing</button> fw: \''+fwname+'\'';
	}
	$("ldfrmw").innerHTML = is;
}

function miAuthorization() {
	gattServer.getPrimaryService(0xfe95)
		.then(service => {
			addClog("Found Main service");
			enc_main = service;
			return enc_main.getCharacteristic(0x0010);
		}).then(characteristic => {
			addClog("Found enc_10 char");
			enc_10 = characteristic;
			return enc_main.getCharacteristic(0x0019);
		}).then(characteristic => {
			addClog('Found enc_19 char');
			enc_19 = characteristic;
			miConnected = true;
			return enc_10.startNotifications().then(() => {
				enc_10.addEventListener('characteristicvaluechanged', event => {
					var value = bytesToHex(event.target.value.buffer);
					addClog("Enc_10: " + value);
					if (value == "11000000") { // REG_SUCCESS
						setStatus("Registration successfull");
						addLog("Registration successfull");
						sendLogin();
					} else if (value == "12000000") { // REG_FAILED
						addLog("Registration failed!");
						setStatus("Registration failed!");
					} else if (value == "13000000") { // REG_VERIFY_SUCC
						addLog("Registration verify successfull");
						setStatus("Registration verify successfull");
					} else if (value == "14000000") { // REG_VERIFY_FAIL
						addLog("Registration verify failed!");
						setStatus("Registration verify failed!");
					} else if (value == "21000000") { // LOG_SUCCESS
						is_logged_in = true;
						addLog("Login successfull");
						setStatus("Login successfull");
						menuUpgrade();
					} else if (value == "22000000") { // LOG_INVALID_LTMK
						addLog("Login invalid LMTK!");
						setStatus("Login invalid LMTK!");
					} else if (value == "23000000") { // LOG_FAILED
						addLog("Login Failed!");
						setStatus("Login Failed!");
					} else	if (value == "e0000000") { // ERR_NOT_REGISTERED
						addLog("Not registered!");
						setStatus("Not registered!");
					} else	if (value == "e1000000") { // ERR_REGISTERED
						addLog("Error Registered!");
						setStatus("Error Registered!");
					} else	if (value == "e2000000") { // ERR_REPEAT_LOGIN
						is_logged_in = true;
						addLog("Repeat login!");
						setStatus("Repeat login!");
						menuUpgrade();
					} else	if (value == "e3000000") { // ERR_INVALID_OOB
						addLog("Error: Invalid OOB!");
						setStatus("Invalid OOB!");
					}
				});
			}).then(characteristic => {
				return enc_19.startNotifications().then(() => {
					enc_19.addEventListener('characteristicvaluechanged', event => {
						var value = bytesToHex(event.target.value.buffer);
						addClog("Enc_19: " + value);
						if (value.substring(0, 6) == "000004") {
							if (value.substring(6, 8) == "00") {
								mainCharSend("00000500" + value.substring(8), enc_19).then(function(character) {
								}).catch(function(err) {updateFail(err);});
							} else if (value.substring(6, 8) == "01") {
								mainCharSend("00000501" + value.substring(8), enc_19).then(function(character) {
									setTimeout(sendLogin, 250);
								}).catch(function(err) {updateFail(err);});
							}
						} else if (mode_activation == 1) {
							if (value.substring(0, 16) == "0000020001000000") {
								device_new_id = value.substring(16);
								$("known_id").value = hex2ascii(device_new_id.substring(2));
								mainCharSend("00000100", enc_19).then(function(character) {
									setTimeout(startRegister, 250);
								}).catch(function(err) { updateFail(err); });
							} else if (value == "000000000100") {
								is_activated = false;
								mainCharSend("00000101", enc_19);
							} else if (value == "000000000200") {
								is_activated = true;
								mainCharSend("00000101", enc_19);
							} else if ((is_activated == true) && (state == 0) && value.substring(0, 4) == "0100") {
								device_known_id = value.substring(4);
							} else if ((is_activated == true) && (state == 0) && value.substring(0, 4) == "0200") {
								device_known_id += value.substring(4);
								device_new_id = device_known_id.substring(8);
								$("known_id").value = hex2ascii(device_known_id.substring(10));
								mainCharSend("00000100", enc_19).then(function(character) {
									setTimeout(startRegister, 250);
								}).catch(function(err) { updateFail(err); });
							} else if (value == "010001000000") {
								mainCharSend("00000100", enc_19).then(function(character) {
									setTimeout(startRegister, 250);
								}).catch(function(err) { updateFail(err); });
							} else if ((state == 1) && (value == "00000101")) {
								state = 2;
								mainCharSend("0100" + own_public_key.substring((36 * 0) + 2, (36 * 0) + 36 + 2), enc_19).then(function(character) {
									mainCharSend("0200" + own_public_key.substring((36 * 1) + 2, (36 * 1) + 36 + 2), enc_19).then(function(character) {
										mainCharSend("0300" + own_public_key.substring((36 * 2) + 2, (36 * 2) + 36 + 2), enc_19).then(function(character) {
											mainCharSend("0400" + own_public_key.substring((36 * 3) + 2, (36 * 3) + 36 + 2), enc_19);
										}).catch(function(err) { updateFail(err); });
									}).catch(function(err) { updateFail(err); });
								}).catch(function(err) { updateFail(err); });
							} else if (value == "000000030400")
								mainCharSend("00000101", enc_19);
							else if ((state == 2) && value.substring(0, 4) == "0100") {
								device_public_key = "04" + value.substring(4);
							} else if ((state == 2) && value.substring(0, 4) == "0200") {
								device_public_key += value.substring(4);
							} else if ((state == 2) && value.substring(0, 4) == "0300") {
								device_public_key += value.substring(4);
							} else if ((state == 2) && value.substring(0, 4) == "0400") {
								device_public_key += value.substring(4);
								mainCharSend("00000100", enc_19).then(function(character) {
									makeSharedKey();
								}).catch(function(err) { updateFail(err); });
							} else if ((state == 2) && (value == "00000101")) {
								state = 3;
								mainCharSend("0100" + mi_write_did.substring(36 * 0, (36 * 0) + 36), enc_19).then(function(character) {
									mainCharSend("0200" + mi_write_did.substring(36 * 1, (36 * 1) + 36), enc_19);
								}).catch(function(err) { updateFail(err); });
							} else if ((state == 3) && (value == "00000100")) {
								state = 0;
								mainCharSend("13000000", enc_10); // REG_VERIFY_SUCC ?
							} else if (value == "000001050100") {
								addLog("Received Timeout from device");
							} else if (value == "12000000") {
								addLog("Register Failed!");
							} else if (value == "11000000") {
								addLog("Register successfull");
							}
						} else { //Mode Login
							if ((state == 0) && (value == "00000101")) {
								state = 1;
								mainCharSend("0100" + mi_random_key, enc_19);
							} else if ((state == 1) && (value == "0000000d0100")) {
								state = 2;
								mainCharSend("00000101", enc_19);
							} else if ((state == 1) && (value.substring(0, 8) == "0000020d")) {
								state = 12;
								mi_random_key_recv = value.substring(8);
								do_login_generate();
								mainCharSend("00000300", enc_19);
							} else if ((state == 2) && value.substring(0, 4) == "0100") {
								state = 3;
								mi_random_key_recv = value.substring(4);
								do_login_generate();
								mainCharSend("00000100", enc_19);
							} else if ((state == 3) && (value == "0000000c0200")) {
								state = 4;
								mainCharSend("00000101", enc_19);
							} else if ((state == 12) && (value.substring(0, 8) == "0000020c")) {
								state = 13;
								mi_device_info_recv = value.substring(8);
								mainCharSend("00000300", enc_19).then(function(character) {
									if (expected_device_infos == mi_device_info_recv) {
										addLog("Received device infos are correct");
										mainCharSend("0000000a0100", enc_19);
									} else {
										addLog("Received device infos are not correct");
										state = 0;
										mainCharSend("00000100", enc_19);
									}
								}).catch(function(err) {updateFail(err);});
							} else if ((state == 4) && value.substring(0, 4) == "0100") {
								state = 5;
								mi_device_info_recv = value.substring(4);
							} else if ((state == 5) && value.substring(0, 4) == "0200") {
								state = 6;
								mi_device_info_recv += value.substring(4);
								if (expected_device_infos == mi_device_info_recv)
									addLog("Received device infos are correct");
								else
									addLog("Received device infos are not correct");
								mainCharSend("00000100", enc_19).then(function(character) {
									mainCharSend("0000000a0200", enc_19);
								})
							} else if ((state == 6) && (value == "00000101")) {
								state = 7;
								mainCharSend("0100" + mi_device_info_send.substring(36 * 0, (36 * 0) + 36), enc_19).then(function(character) {
									mainCharSend("0200" + mi_device_info_send.substring(36 * 1, (36 * 1) + 36), enc_19);
								}).catch(function(err) { updateFail(err); });
							} else if ((state == 13) && (value == "00000101")) {
								state = 14;
								mainCharSend("0100" + mi_device_info_send, enc_19);
							} else if ((state == 14) && (value == "00000100")) {
								state = 0;
								addClog("Waiting for terminating code ...");
							}
						}
					});
					addLog("Connected");
					if(bluetoothDevice.name == 'LYWSD03MMC') {
						let shwsr = devinfo.hrstr.substr(0,4);
						if(shwsr == 'B1.4' || shwsr == '0000') cfg.hver = 0x80; // sensor SHTC3
						else if(shwsr == 'B1.5') cfg.hver = 10;
						else if(shwsr == 'B1.6') cfg.hver = 3;
						else if(shwsr == 'B1.9') cfg.hver = 4;
						else if(shwsr == 'B1.7' || shwsr == 'B2.0') cfg.hver = 5;
						else if(shwsr == 'B1.8') cfg.hver = 0; // ??
						else {
							cfg.hver = null;
							$("ldfile").hidden = false;
						}
					} else if (bluetoothDevice.name.substr(0,8) == 'MHO-C401') {
						let swnum = parseInt(devinfo.srstr.substr(0,4));
						if(swnum > 14) {
							addLog("Found new version of SW:"+swnum+" MHO-C401N");
							cfg.hver = 8;
						} else {
							addLog("Found old version of SW:"+swnum+" MHO-C401");
							cfg.hver = 1;
						}
					} else if (bluetoothDevice.name.substr(0,4) == 'C121') cfg.hver = 11; // MHO-C122
					else if (bluetoothDevice.name.substr(0,20) == "Qingping Temp & RH M") cfg.hver = 2;
					else if (bluetoothDevice.name.substr(0,18) == "Qingping Temp RH M") cfg.hver = 7;
					else if (bluetoothDevice.name.substr(0,21) == "Qingping Temp RH Lite") cfg.hver = 6;
					else if (bluetoothDevice.name == "MJWSD05MMC") cfg.hver = 9;
					else {
						cfg.hver = null;
						$("ldfile").hidden = false;
					}
					if(cfg.hver != null)
						hwver_id = cfg.hver & 0x0f;
					let s="'"+bluetoothDevice.name;
					if (devinfo.hrstr) s+=" HW:"+devinfo.hrstr;
					s+="' connected, you can now Do the Activation to either get the Token or flash a new Firmware";
					setStatus(s);
				});
			});
		}).catch(handleError);
}
function startRegister() {
	mainCharSend("15000000", enc_10).then(function(character) {
		mode_activation = 1;
		state = 1;
		doGenerate();
		mainCharSend("000000030400", enc_19);
	}).catch(function(err) { updateFail(err);});
}
function sendRegister() {
	if (miConnected == false) {
		addLog("Not connected");
		return;
	}
	addLog("Activating now, please wait...");
	state = 0;
	mode_activation = 1;
	doGenerate();
	mainCharSend("a2000000", enc_10);
}
function sendLogin() {
	addLog("Send Login, please wait...");
	mi_random_key = bytesToHex(window.crypto.getRandomValues(new Uint8Array(16)));
	state = 0;
	mode_activation = 0;
	mainCharSend("24000000", enc_10).then(function(character) {
		mainCharSend("0000000b0100", enc_19);
	}).catch(function(err) {updateFail(err);});
}

function getDevVersion(devInfEnabled) {
	var infoservice;
	devinfo.hrstr = null;
	devinfo.srstr = null;
	devinfo.frstr = null;
	devinfo.flg = 0;
	if (devInfEnabled == true) { return new Promise((resolve, reject) => {
		gattServer.getPrimaryService(0x180a).then(service => {
			addClog("Found Device Information Service");
			infoservice = service;
			return getStrVersion(infoservice, 0x2a26).then(value => {
				devinfo.flg |= 1;
				devinfo.frstr = value;
				return getStrVersion(infoservice, 0x2a27).then(value => {
					devinfo.flg |= 2;
					devinfo.hrstr = value;
					return getStrVersion(infoservice, 0x2a28).then(value => {
						devinfo.flg |= 4;
						devinfo.srstr = value;
						return resolve(devinfo.flg);
					}).catch(error => { addClog(error);});
				}).catch(error => { addClog(error);});
			}).catch(error => { addClog(error); return resolve(null);});
		}).catch(error => { addClog(error); return resolve(null);});
	}).catch(error => { addClog(error); return resolve(null);});
	} else	return devinfo.flg;
}

function doConnect() {
 if(bluetoothDevice != null) {
	bluetoothDevice.gatt.connect().then(server => {
		addClog("Found GATT server");
		gattServer = server;
		return gattServer.getPrimaryServices();
	}).then(services => {
		miEnabled = false;
		otaEnabled = false;
		customEnabled = false;
		devIdEnabled = false;
		devTest = false;
		devInfEnabled = false;
		EnabledQinping = false;
		for (var i = 0; i < services.length; i++) {
			addClog("Services: " + services[i].uuid);
			if (services[i].uuid == "00010203-0405-0607-0809-0a0b0c0d1912") otaEnabled = true;
			else if (services[i].uuid == "00001f10-0000-1000-8000-00805f9b34fb") customEnabled = true;
			else if (services[i].uuid == "22210000-554a-4546-5542-46534450464d") EnabledQinping = true;
			else if (services[i].uuid == "ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6") miEnabled = true;
			else if (services[i].uuid == "0000181a-0000-1000-8000-00805f9b34fb") devIdEnabled = true;
			else if (services[i].uuid == "0000ffe0-0000-1000-8000-00805f9b34fb") devTest = true;
			else if (services[i].uuid == "0000180a-0000-1000-8000-00805f9b34fb") devInfEnabled = true; // Device Information Service
		}
		if(otaEnabled)
			return gattServer.getPrimaryService('00010203-0405-0607-0809-0a0b0c0d1912');
		else {
			addAlog("Not found Telink OTA service!");
		}
		connectTrys = 1000;
		return resolve(null);
	}).then(service => {
		addClog("Found Telink OTA service");
		Theservice = service;
		return Theservice.getCharacteristic('00010203-0405-0607-0809-0a0b0c0d2b12');
	}).then(characteristic => {
		addClog("Found Telink OTA write characteristic");
		writeCharacteristic = characteristic;

	getDevVersion(devInfEnabled).then(hwstr => {
		if (devinfo.hrstr) addLog('Hardware Revision String: ' + devinfo.hrstr);
		if (devinfo.srstr) addLog('Software Revision String: ' + devinfo.srstr);
		if (devinfo.frstr) addLog('Firmware Revision String: ' + devinfo.frstr);
		if (miEnabled) {
			addLog("Detected Mi device");
			setStatus("Detected Mi device");
			$("custcfg").innerHTML = '<hr>When doing an activation here the device is needed to be activated in the Mi app again when wanted to use there.<br><button type="button" onclick="sendRegister();">Do Activation</button> <button type="button" onclick="keyMiLogin();">Login</button><br>Device known id:<br><input size="40" type="text" id="known_id" value=""><br>Mi Token:<br><input size="40" type="text" id="mi_token" value=""><br>Mi Bind Key:<br><input size="40" type="text" id="mi_bind_key" value=""><br><br>';
			if (bluetoothDevice.name.substr(0,10) == "MJWSD05MMC") fwmaxsize = 0x34000;
			miAction();
		} else if (customEnabled) {
			let s = '<button type="button" onclick="sendCustomSetting(&quot;55&quot;);">Get Config</button><br>Send commands to custom firmware:<br><input type="text" id="cmdTXT" value=""><button type="button" onclick="sendCustomSetting($(&quot;cmdTXT&quot;).value,settingsCharacteristics);">Send</button><br>';
			if (devTest) {
				addLog("Detected Test device");
				setStatus("Detected Test device");
				getTestCharacteristic();
				s += '<a href="https://pvvx.github.io/ATC_MiThermometer/TelinkOTA.html">TelinkOTA</a><br>';
			} else {
				addLog("Detected custom Firmware");
				setStatus("Detected custom Firmware");
				customAction();
			}
			$("custcfg").innerHTML = s;
		} else if(EnabledQinping && bluetoothDevice.name.substr(0,15) == "Qingping Motion")
			CGPR1_Action();
		else if(EnabledQinping && bluetoothDevice.name.substr(0,21) == "Qingping Temp RH Lite")
			CGDK2_Action();
		else if(EnabledQinping && bluetoothDevice.name.substr(0,20) == "Qingping Temp & RH M")
			CGG1_Action("2020-2021");
		else if(EnabledQinping && bluetoothDevice.name.substr(0,18) == "Qingping Temp RH M")
			CGG1_Action("2022");
		else {
			setStatus("Connected.")
			miEnabled = true;
			miAuthorization();	//	miConnected
			$("ldfile").hidden = false;
			$("custcfg").innerHTML = '<hr>When doing an activation here the device is needed to be activated in the Mi app again when wanted to use there.<br><button type="button" onclick="sendRegister();">Do Activation</button> <button type="button" onclick="skipActivation();">Skip Activation</button>	 <button type="button" onclick="keyMiLogin();">Login</button><br>Device known id:<br><input size="40" type="text" id="known_id" value=""><br>Mi Token:<br><input size="40" type="text" id="mi_token" value=""><br>Mi Bind Key:<br><input size="40" type="text" id="mi_bind_key" value=""><br><br>';
		}}).catch(handleError);
	}).catch(handleError);
 }
}

function getStrVersion(infoservice, suuid) {
 return new Promise((resolve, reject) => {
	infoservice.getCharacteristic(suuid).then(characteristic => {
		characteristic.readValue().then(value => {
			return resolve(new TextDecoder("utf-8").decode(value));
		}).catch(error => {addClog(error);	return resolve(null); });
	}).catch(error => {addClog(error);	return resolve(null); });
})};

function reConnect() {
	if (bluetoothDevice != null) bluetoothDevice.gatt.disconnect();
	resetVariables();
	addLog("Reconnect");
	connectTrys = 0;
	doConnect();
}

function skipActivation() {
	if(cus017Chr && EnabledQinping)
		$("custcfg").innerHTML = '<hr><button type="button" onclick="sendCmdClear();">Clear all settings and reset device (into Qingping mode)</button><br><br>MTimer: <input type="text" id="mtimer" value="?"> ms <button type="button" onclick="getMTimer();">Get</button> <button type="button" onclick="setMTimer();">Set</button><br>';
	else
		$("custcfg").innerHTML = '';
	is_logged_in = true;
}

function startDFU() {
	addLog("Start DFU");
	if ((miConnected==true) && (is_logged_in==false)){
		addLog("Please do the Activation first!");
		return;
	}
	if (blockCount*16 > fwmaxsize){
		let szk = fwmaxsize >> 10;
		if(bigOtaEnabled && settingsCharacteristics){
			if(!confirm('OTA size over '+szk+'k! Clean the whole story "Memo"?')) return;
			szk = blockCount*16 >> 10;
			let s = 'Clear Ext.OTA region ('+szk+'kib)...';
			addAlog(s);
			setStatus(s)
			settingsCharacteristics.writeValue(new Uint8Array([0x73, 0,0,4,0, szk&0xff, (szk>>8)&0xff, (szk>>16)&0xff, (szk>>24)&0xff]));
			return;
		} else {
			let s = 'Big OTA (size over '+szk+'k) is not supported!';
			setStatus(s);
			addAlog(s);
			return;
		}
	}
	updateBegin();
}

function addLog(logTXT) {
	var time = new Date().toLocaleTimeString();
	var logString = time + ": " + logTXT;
	$("log").innerHTML += logString + "<br>";
}

function addClog(logTXT) {
	console.log(logTXT);
}

function addAlog(logTXT) {
	console.log(logTXT);
	addLog(logTXT);
}

function clearLog() {
	$("log").innerHTML = "";
}

function setStatus(status) {
	addClog("Status: " + status);
	$("percent").innerHTML = "Status: " + status;
}

function updateFail(err) {
	addLog("Update error: " + err);
	setStatus("Update error: " + err);
}

function decimalToHex(d, padding) {
	var hex = Number(d).toString(16);
	while (hex.length < 4) {
		hex = "0" + hex;
	}
	return hex;
}

function hexToBytes(hex) {
	for (var bytes = [], c = 0; c < hex.length; c += 2)
		bytes.push(parseInt(hex.substr(c, 2), 16));
	return new Uint8Array(bytes);
}

function bytesToHex(data) {
	return new Uint8Array(data).reduce(function(memo, i) {
		return memo + ("0" + i.toString(16)).slice(-2);
	}, "");
}

function makeRandomID(length) {
	var result = '';
	var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	var charactersLength = characters.length;
	for (var i = 0; i < length; i++) {
		result += characters.charAt(Math.floor(Math.random() * charactersLength));
	}
	return bytesToHex(new TextEncoder("utf-8").encode(result));
}

function crc16_modbus(buffer) {
	var crc = 0xFFFF;
	var odd;
	for (var i = 0; i < buffer.length; i++) {
		crc = crc ^ buffer[i];
		for (var j = 0; j < 8; j++) {
			odd = crc & 0x0001;
			crc = crc >> 1;
			if (odd) {
				crc = crc ^ 0xA001;
			}
		}
	}
	return crc;
};
//-------------
function hex2ascii(hexx) {
	var hex = hexx.toString();
	var str = '';
	for (var i = 0;
		(i < hex.length && hex.substr(i, 2) !== '00'); i += 2)
		str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
	return str;
}
var crc32 = (function() {
	let table = new Uint32Array(256);
	for(var i=256; i--;) {
		let tmp = i;
		for(let k=8; k--;) {
			tmp = tmp & 1 ? 0xEDB88320 ^ tmp >>> 1 : tmp >>> 1;
		}
		table[i] = tmp;
	}
	return function( data ) {
		let crc = -1;
		let l = data.length;
		for(let i=0; i<l; i++) {
			crc = crc >>> 8 ^ table[ crc & 255 ^ data[i] ];
		}
		return (crc >>> 0);
	};
})();

function testOTAFirmware(data) {
	let fsize = data.byteLength;
	addClog("File size = 0x"+ fsize.toString(16));
	if (fsize < 64)
		return "Wrong binary Telink OTA firmware size!";
	if(bigOtaEnabled) {
		if(fsize > 208*1024)
			return "Size firmware is more 208 kbytes!";
	} else if(fsize > fwmaxsize)
			return "Size firmware is more "+fwmaxsize+" bytes!";
	let head = new DataView(data, 0, 0x20);
	if(head.getUint32(0x08, true) != 0x544c4e4b){
		return "Incorrect head in Telink OTA binary firmware";
	}
	let hsize = head.getUint32(0x18, true);
	addClog("Size in head = 0x" + hsize.toString(16));
//	if((hsize > fsize) || ((hsize & 0x0f) != 4)) {
//		return "Invalid size pointer in Telink OTA binary firmware!";
//	}
	let fcrc = new Uint32Array(2);
	fcrc[0] = crc32(new Uint8Array(data.slice(0, hsize - 4)));
	let x = new DataView(data, hsize - 4, 4);
	fcrc[1] = x.getUint32(0, true);
	addClog("File CRC = 0x" + fcrc[1].toString(16) + ", Check CRC = 0x" + fcrc[0].toString(16));
//	if(fcrc[0] != fcrc[1]) {
//		return "Incorrect CRC in Telink OTA binary firmware!";
//	}
	return "ok";
}
//-------------
function getFirmwareArray(data, filename) {
	addAlog("File: " + filename);
	addClog("File: " + filename);
	let s = testOTAFirmware(data);
	if(s != "ok") {
		addAlog(s);
		blockCount = 0;
		firmwareArray = "";
		fwname = "";
		$("ldfrmw").innerHTML=s;
		alert(s);
		return;
	}
	firmwareArray = bytesToHex(data);
	addAlog("File size: " + (firmwareArray.length/2).toString(10) + " bytes");
	if (firmwareArray.length % 32 !== 0) { // pad last block to 16bytes
		var padHex = "ffffffffffffffffffffffffffffffff";
		firmwareArray += padHex.substr(0, 32 - firmwareArray.length % 32);
	}
	blockCount = firmwareArray.length / 32;
	addAlog("Count: " + blockCount);
	fwname = filename;
	menuUpgrade();
}

function ajax_file(filename, fn) {
	let xhr;
	if(window.XMLHttpRequest) xhr = new XMLHttpRequest();
	else if(window.ActiveXObject) xhr = new ActiveXObject("Microsoft.XMLHTTP")
	if (!xhr) { addClog(msg("Your browser does not support AJAX!")); fn(); return;};
	xhr.onreadystatechange = function() {
		if (xhr.readyState == 4) {
			if (xhr.status == 200) fn(xhr.response, filename);
			else { addClog('XMLHttpRequest: response ' + xhr.status); fn();}
			xhr.abort();
			xhr = null;
		}
	};
	xhr.ontimeout = function() { addClog('XMLHttpRequest: timeout'); fn();};
	xhr.onerror = function () { addClog('XMLHttpRequest error!'); fn();};
	xhr.open('GET', rawurl+filename, true);
	xhr.timeout = 10000;
	xhr.responseType = "arraybuffer";
	xhr.send();
}

function getOtaJson(d, name) {
	if (!d) {
		addClog("No load index file!");
	} else {
		let str = '';
		if (typeof d === 'string')
			str = d;
		else
			str = new TextDecoder("utf-8").decode(d);
		let x = JSON.parse(str);
		if(x.version) {
			otafiles = x;
			otafiles.loaded = true;
			addClog(otafiles);
		}
	}
}

function FirmwareUpgrade() {
	if(hwver_id != null) {
		let fn = otafiles.custom[hwver_id];
		addAlog("Load firmware file '"+fn+"'...");
		ajax_file(fn, getFirmwareArray);
	}
}
function BetaFirmwareUpgrade() {
	if(hwver_id != null) {
		let fn = otafiles.betafw[hwver_id];
		addAlog("Load firmware file '"+fn+"'...");
		ajax_file(fn, getFirmwareArray);
	}
}
function BackToOriginal() {
	if(hwver_id != null) {
		let fn = otafiles.original[hwver_id];
		addAlog("Load firmware file '"+fn+"'...");
		ajax_file(fn, getFirmwareArray);
	}
}

window.onload = function() {
	//TODO Test enable -web-platform-features
	$("MAC").innerHTML= '#enable-experimental-web-platform-features may be needed to read MAC (copy link: <a href=chrome://flags/#enable-experimental-web-platform-features>Chrome<a>, <a href=opera://flags/#enable-experimental-web-platform-features>Opera<a>, <a href=edge://flags/#enable-experimental-web-platform-features>Edge<a>)';
	addClog("Load index file 'firmware.json'...");
	ajax_file('firmware.json', getOtaJson);
	document.querySelector("#file").addEventListener("change", function() {
		let reader = new FileReader();
		reader.fname = "";
		reader.onload = function() {getFirmwareArray(this.result, this.fname);};
		if (this.files[0] != null) {
			reader.fname = this.files[0].name;
			reader.readAsArrayBuffer(this.files[0]);
		} else	addLog("No file selected");	}, false);
}

function updateBegin() {
	if (blockCount <= 0) {
		addLog("No file selected aborting");
		return;
	} else if (blockCount*16 >= fwmaxsize) {
		alert('Big OTA is not supported!');
		return;
	}
	if (miEnabled && writeCharacteristicSpeed != null) mainCharSend("1e0000", writeCharacteristicSpeed); // this makes the upload faster
	setTimeout(function() {
		otaCharSend("00ff").then(function(character) {
			otaCharSend("01ff").then(function(character) {
				setTimeout(function() {
					startTime = new Date().getTime();
					sendOTAblock(0);
				}, 300);
			}).catch(function(err) {
				updateFail(err);
			});
		}).catch(function(err) {
			updateFail(err);
		});
	}, 500);
}

function sendOTAblock(blockNr) {
	if (blockNr >= blockCount) {
		sendLastOTA();
		return;
	}
	setStatus("Sending block nr: " + blockNr + " from " + blockCount + ", " + Math.floor(blockNr / (blockCount * 1.0) * 100) + "% done, time since start " + (new Date().getTime() - startTime) / 1000.0 + "s");
	var blockNrString = getHexBLockCount(blockNr);
	var blockString = blockNrString + firmwareArray.substring(blockNr * 32, blockNr * 32 + 32);
	var blockCRC = getHexCRC(blockString);
	otaCharSend(blockString + blockCRC).then(function(character) {
		setTimeout(function() {
			if ((blockNr + 1) % 8 == 0) {
				writeCharacteristic.readValue().then(function(result) {
					addClog('reading OTA');
					sendOTAblock(blockNr + 1);
				}).catch(function(err) {
					updateFail(err);
				});
			} else {
				sendOTAblock(blockNr + 1);
			}
		}, 0);
	}).catch(function(err) {
		updateFail(err);
	});
}

function getHexBLockCount(count) {
	var tempHEX = decimalToHex(count);
	return tempHEX.substring(2, 4) + tempHEX.substring(0, 2);
}

function getHexCRC(data) {
	var tempCRC = decimalToHex(crc16_modbus(hexToBytes(data)));
	return tempCRC.substring(2, 4) + tempCRC.substring(0, 2);
}

function sendLastOTA() {
	var data = "02ff" + getHexBLockCount(blockCount - 1) + getHexBLockCount(~(blockCount - 1) & 0xffff);
	otaCharSend(data).then(function(character) {
		addLog("Update done after " + (new Date().getTime() - startTime) / 1000 + " seconds");
		setStatus("Update done after " + (new Date().getTime() - startTime) / 1000 + " seconds");
	}).catch(function(err) {
		updateFail(err);
	});
}

var otaCharSend = function(data) {
	return new Promise(function(resolve, reject) {
		addClog("OTA: " + data);
		writeCharacteristic.writeValue(hexToBytes(data)).then(function(character) {
			resolve("ok");
		}).catch(function(err) {
			reject("some error while sending char data");
		});
	});
}

function sendCustomSetting(data){
	if((hexToBytes(data))[0] == 0x35)
		flg_memo_act = true;
	mainCharSend(data, settingsCharacteristics).then(function() {
		addLog("Settings " + data + " was send successful");
	}).catch(function(err) {
		addLog("Error on sending setting " + data);
	});
}

var mainCharSend = function(data, characteristic) {
	return new Promise(function(resolve, reject) {
		addClog("Send: " + data);
		characteristic.writeValue(hexToBytes(data)).then(function(character) {
			resolve("ok");
		}).catch(function(err) {
			reject("some error while sending char data");
		});
	});
}

function doGenerate() {
	window.crypto.subtle.generateKey({
			name: 'ECDH',
			namedCurve: 'P-256'
		}, false, ['deriveKey', 'deriveBits'])
		.then(own_key => {
			keypair = own_key
			return window.crypto.subtle.exportKey('raw', own_key.publicKey);
		})
		.then(ownPublicKeyExported => {
			own_public_key = bytesToHex(ownPublicKeyExported);
		})
		.catch(err => {
			addLog(err);
		});
}
function makeSharedKey() {
	window.crypto.subtle.importKey('raw', hexToBytes(device_public_key), {
			name: 'ECDH',
			namedCurve: 'P-256'
		}, true, [])
		.then(device_key_imported => {
			return window.crypto.subtle.deriveBits({
				name: 'ECDH',
				namedCurve: 'P-256',
				public: device_key_imported
			}, keypair.privateKey, 256)
		})
		.then(sharedSecret => {
			shared_key = bytesToHex(sharedSecret);
			deriveTheKey();
		})
		.catch(err => {
			addLog(err)
		})
}
function deriveTheKey() {
	var derived_key = sjcl.codec.hex.fromBits(sjcl.misc.hkdf(sjcl.codec.hex.toBits(shared_key), 8 * 64, null, "mible-setup-info", sjcl.hash["sha256"]));
	$("mi_token").value = derived_key.substring(0, 24);
	$("mi_bind_key").value = derived_key.substring(24, 56);
	var mi_bind_A = derived_key.substring(56, 88);
	mi_write_did = sjcl.codec.hex.fromBits(sjcl.mode.ccm.encrypt(new sjcl.cipher.aes(sjcl.codec.hex.toBits(mi_bind_A)), sjcl.codec.hex.toBits(device_new_id), sjcl.codec.hex.toBits("101112131415161718191A1B"), sjcl.codec.hex.toBits("6465764944"), 32));
	mainCharSend("000000000200", enc_19);
}
function do_login_generate() {
	var salt = hexToBytes(mi_random_key + mi_random_key_recv);
	var salt1 = hexToBytes(mi_random_key_recv + mi_random_key);
	var derived_key = sjcl.codec.hex.fromBits(sjcl.misc.hkdf(sjcl.codec.hex.toBits($("mi_token").value), 8 * 64, sjcl.codec.hex.toBits(bytesToHex(salt)), "mible-login-info", sjcl.hash["sha256"]));
	expected_device_infos = sjcl.codec.hex.fromBits(new sjcl.misc.hmac(sjcl.codec.hex.toBits(derived_key.substring(0, 32))).mac(sjcl.codec.hex.toBits(bytesToHex(salt1))));
	mi_device_info_send = sjcl.codec.hex.fromBits(new sjcl.misc.hmac(sjcl.codec.hex.toBits(derived_key.substring(32, 64))).mac(sjcl.codec.hex.toBits(bytesToHex(salt))));
}
function keyMiLogin() {
	let tk = $("mi_token").value;
	let bk = $("mi_bind_key").value;
	if(tk.length == 24) {
		if(bk.length == 32)
			sendLogin();
		else
			addLog("Bind Key must be 16 hex digits!")
	} else
		addLog("Mi Token must be 12 hex digits!")
}

const lcd_digcode = [0xf5,0x05,0xd3,0x97,0x27,0xb6,0xf6,0x15,0xf7,0xb7];
function lcd_clock() {
	let date = new Date();
	let hours = date.getHours();
	let minutes = date.getMinutes();
	let lcdb = new Uint8Array(7);
	lcdb[0] = 0x60;
	lcdb[1] = lcd_digcode[parseInt(minutes % 10)];
	lcdb[2] = lcd_digcode[parseInt(minutes / 10)];
	lcdb[4] = lcd_digcode[parseInt(hours % 10)];
	lcdb[5] = lcd_digcode[parseInt(hours / 10)];
	addClog("Send cmd (60): Set LCD data");
	settingsCharacteristics.writeValue(lcdb).then(_ => {addClog('Send data ok'); addLog("Send 'Send clock data on LCD' ok");});
}
function setDevTime() {
	let time = Date.now()/1000;
	time -= (new Date()).getTimezoneOffset() * 60;
	blk = new Uint8Array(5);
	blk[0] = 0x23;
	blk[1] = time & 0xff;
	blk[2] = (time >> 8) & 0xff;
	blk[3] = (time >> 16) & 0xff;
	blk[4] = (time >> 24) & 0xff;
	addClog("Send cmd Set DevTime ("+dump(blk, blk.length)+")...");
	settingsCharacteristics.writeValue(blk).then(_ => {
		addAlog('Send new DevTime ok');
	});
}
function calkDeltaTime() {
	devtime.step = 1;
	addClog("Send cmd Get DevTime...");
	blk = new Uint8Array(1);
	blk[0] = 0x23;
	settingsCharacteristics.writeValue(blk).then(_ => {
		addAlog('Get DevTime...');
	});
}
function lcd_restore() {
	addClog("Send cmd (6100): Restore show LCD");
	settingsCharacteristics.writeValue(new Uint8Array([0x61, 0])).then(_ => {addClog('Send data ok'); addLog("Send 'Repair LCD' ok");});
}

function sendPinCode() {
	if(pincode.enable) {
		let el = $("pincode");
		let x = parseInt(el.value);
		let s = ("0000000" + x.toString(10)).slice(-6);
		if(el.value.length == 6 && x <= 999999 && x >= 0) {
			el.value = s;
			addLog("PinCode: '"+s+"'");
			settingsCharacteristics.writeValue(new Uint8Array([0x70, x&0xff, (x>>8)&0xff, (x>>16)&0xff, (x>>24)&0xff])).then(_ => {addAlog('Send pincode ok');});
		} else	{
			el.value = s;
			addLog("Must be 6 decimal digits! 000000..999999, 6 digits, if '000000' - PinCode Disable.")
		}
	}
}
function CleanDevName() {
	addClog("Send cmd (0100) Clean DevName...");
	settingsCharacteristics.writeValue(new Uint8Array([0x01, 0])).then(_ => {
			addAlog('Send Clean DevName ok');
	});
}
function sendDevName() {
	if(dnm.enable) {
		let el = $("dev_name").value;
		if(el.length >= 1 && el.length <= 12) {
			let encoder = new TextEncoder();
			blk = new Uint8Array(el.length + 1);
			blk.set(encoder.encode(el), 1);
			blk[0] = 0x01;
			addClog("Send cmd New DevName ("+dump(blk, blk.length)+")...");
			settingsCharacteristics.writeValue(blk).then(_ => {
				addAlog('Send New DevName ok');
			});
		}
	}
}
function CleanMAC() {
	addClog("Send cmd Clean MAC (1000)...");
	settingsCharacteristics.writeValue(new Uint8Array([0x10, 0])).then(_ => {
		addAlog('Send Clean MAC ok');
	});
}
function sendMAC() {
	if(mikeys.mac) {
		let el = $("mi_mac").value;
		let len = el.length;
		addClog(len + ' ' + el);
		if(len == 12 || len == 16) {
			let mac = hexToBytes(el);
			len = mac.length;
			addClog(len + ' ' + el);
			if(len == 6 || len == 8) {
				let blk = new Uint8Array(len+2);
				blk[0] = 0x10;
				blk[1] = len;
				blk[2] = mac[5];
				blk[3] = mac[4];
				blk[4] = mac[3];
				blk[5] = mac[2];
				blk[6] = mac[1];
				blk[7] = mac[0];
				if(len == 8) {
					blk[8] = mac[7];
					blk[9] = mac[6];
				}
				addClog(blk);
				addClog("Send cmd New MAC ("+dump(blk, blk.length)+")...");
				settingsCharacteristics.writeValue(blk).then(_ => {
					addAlog("Send New MAC: "+dump(mac, 6)+" RAND:" +dump(mac.slice(6), 2)+" ok");
				});
			}
		}
		addLog("Must be 6 hex MAC digits [+ 2 hex RandMAC digits]!")
		return;
	}
}

function UpdExt() {
	if(ext.enable && $("extbignumb").value) {
		if(hwver_id == 9) {
			$("extbignumb").value = (ext.big_number / 100.0).toFixed(2);
			$("exttmpsmb").value = (ext.flg >> 4) & 0x07;
			$("extpersent").checked = ((ext.flg & 0x80) !=0 ? 1 : 0);
			$("extbattery").checked = ((ext.flg & 8) !=0 ? 1 : 0);
		} else {
			$("extbignumb").value = (ext.big_number / 10.0).toFixed(1);
			if(hwver_id == 2 || hwver_id == 6 || hwver_id == 7)	 // CGG1 & CGDK2
				$("extsmalnumb").value = (ext.small_number / 10.0).toFixed(1);
			else
				$("extsmalnumb").value = ext.small_number.toFixed(0);
			$("extpersent").checked = ((ext.flg & 8) !=0 ? 1 : 0);
			$("exttmpsmb").value = (ext.flg >> 5) & 0x07;
			$("extbattery").checked = ((ext.flg & 16) !=0 ? 1 : 0);
		}
		$("extsmiley").value = ext.flg & 7;
		$("extvtimed").value = ext.vtime;
	}
}

function sendExt() {
	if(ext.enable) {
		if(hwver_id == 9)  {
			ext.big_number = Math.round(100.0 * parseFloat($("extbignumb").value));
			ext.cfg = (parseInt($("extsmiley").value) & 7) +
			($("extbattery").checked ? 8 : 0) +
			($("extpersent").checked ? 0x80 : 0) +
			((parseInt($("exttmpsmb").value) & 0x07) << 4);
		} else {
			ext.big_number = Math.round(10.0 * parseFloat($("extbignumb").value));
			if(hwver_id == 2 || hwver_id == 6 || hwver_id == 7) // CGG1 & CGDK2
				ext.small_number = Math.round(10.0 * parseFloat($("extsmalnumb").value));
			else
				ext.small_number = parseInt($("extsmalnumb").value);
			ext.cfg = (parseInt($("extsmiley").value) & 7) +
			($("extpersent").checked ? 8 : 0) +
			($("extbattery").checked ? 16 : 0) +
			((parseInt($("exttmpsmb").value) & 7) << 5);
		}
		ext.vtime = parseInt($("extvtimed").value);
		if(ext.vtime < 2) ext.vtime = 2;
		else if(ext.vtime > 65535) ext.vtime = 65535;
		addClog("Send cmd (22 + ext data)...");
		let blk;
		if(hwver_id == 9){
			blk = new Uint8Array([0x22, ext.big_number&0xff, (ext.big_number>>8)&0xff, (ext.big_number>>16)&0xff, (ext.big_number>>24)&0xff, ext.vtime&0xff,(ext.vtime>>8)&0xff,ext.cfg]);
		} else{
			blk = new Uint8Array([0x22, ext.big_number&0xff, (ext.big_number>>8)&0xff,ext.small_number&0xff,(ext.small_number>>8)&0xff,ext.vtime&0xff,(ext.vtime>>8)&0xff,ext.cfg]);
		}
		settingsCharacteristics.writeValue(blk).then(_ => {
			addAlog('Send Ext data: '+dump(blk, blk.length)+' ok');
		});
	}
}
function UpdCmf() {
	if(cmf.enable && $("cmf_tmp_lo").value) {
		$("cmf_tmp_lo").value =	 (cmf.tmp_lo/100.0).toFixed(2);
		$("cmf_tmp_hi").value =	 (cmf.tmp_hi/100.0).toFixed(2);
		$("cmf_hm_lo").value =	(cmf.hm_lo/100.0).toFixed(2);
		$("cmf_hm_hi").value =	(cmf.hm_hi/100.0).toFixed(2);
	}
}
function SendCmf() {
	if(cmf.enable) {
		cmf.tmp_lo = Math.round(100.0 * parseFloat($("cmf_tmp_lo").value));
		cmf.tmp_hi = Math.round(100.0 * parseFloat($("cmf_tmp_hi").value));
		cmf.hm_lo = Math.round(100.0 * parseFloat($("cmf_hm_lo").value));
		cmf.hm_hi = Math.round(100.0 * parseFloat($("cmf_hm_hi").value));
		addClog("Send cmd (20 + cmf data)...");
		settingsCharacteristics.writeValue(new Uint8Array([0x20, cmf.tmp_lo&0xff, (cmf.tmp_lo>>8)&0xff, cmf.tmp_hi&0xff, (cmf.tmp_hi>>8)&0xff, cmf.hm_lo&0xff, (cmf.hm_lo>>8)&0xff, cmf.hm_hi&0xff, (cmf.hm_hi>>8)&0xff])).then(_ => {
			addAlog('Send Cmf data ok');
		});
	}
}
function UpdTrg() {
	if(trg.enable && $("trg_tmp_hst").value) {
		$("trg_tmp_thr").value =  trg.tmp_thr.toFixed(2);
		$("trg_hm_thr").value =	 trg.hm_thr.toFixed(2);
		$("trg_tmp_hst").value =  trg.tmp_hst.toFixed(2);
		$("trg_hm_hst").value =	 trg.hm_hst.toFixed(2);
		if(cfg.ver >= 0x37) {
			$("rds_rpint").value =	trg.rds_rpint;
			$("rds_type").value =  trg.rds_type & 3;
		}
		if(cfg.ver >= 0x39)
			$("rds_invert").checked = ((trg.rds_type & 0x10) != 0);
	}
}
function setNewTBKey() {
	let bk = $("mi_bind_key").value;
	if(bk.length == 32) {
		let bkey = hexToBytes(bk);
		if(bkey.length == 16) {
			let tk = $("mi_token").value;
			if(tk.length == 24) {
				let token = hexToBytes(tk);
				if(token.length == 12) {
					let blk = new Uint8Array(29);
					blk.set(token,1);
					blk.set(bkey,13);
					blk[0] = 0x12;
					addClog(blk);
					addClog("Send cmd MtuSizeExchange (7120)");
					settingsCharacteristics.writeValue(new Uint8Array([0x71,0x20])).then(_ => {
						addClog("Send cmd New bindkey ("+dump(blk, blk.length)+")...");
						settingsCharacteristics.writeValue(blk).then(_ => {
							addAlog("Send cmd New keys ok");
					})});
					return;
				}
			}
			addLog("Mi Token must be 12 hex digits!")
			return;
		}
	}
	addLog("Bind Key must be 16 hex digits!")
}
function sendTrg() {
	if(trg.enable) {
		let blk;
		trg.tmp_thr = Math.round(100.0 * parseFloat($("trg_tmp_thr").value));
		trg.hm_thr = Math.round(100.0 * parseFloat($("trg_hm_thr").value));
		if(cfg.ver >= 0x26) {
			trg.tmp_hst = Math.round(100.0 * parseFloat($("trg_tmp_hst").value));
			trg.hm_hst = Math.round(100.0 * parseFloat($("trg_hm_hst").value));
			addClog("Send cmd (44 + trg data)...");
			if(cfg.ver >= 0x37) {
				trg.rds_rpint = parseInt($("rds_rpint").value);
				trg.rds_type = $("rds_type").value & 3;
				if(cfg.ver >= 0x39) {
					if(trg.rds_type == 3) trg.rds_type += 0x10;
					else trg.rds_type += (($("rds_invert").checked)? 0x10 : 0);
				}
				blk = new Uint8Array([0x44, trg.tmp_thr&0xff, (trg.tmp_thr>>8)&0xff,trg.hm_thr&0xff,(trg.hm_thr>>8)&0xff,trg.tmp_hst&0xff,(trg.tmp_hst>>8)&0xff,trg.hm_hst&0xff,(trg.hm_hst>>8)&0xff,trg.rds_rpint&0xff,(trg.rds_rpint>>8)&0xff,trg.rds_type]);
			} else {
				blk = new Uint8Array([0x44, trg.tmp_thr&0xff, (trg.tmp_thr>>8)&0xff,trg.hm_thr&0xff,(trg.hm_thr>>8)&0xff,trg.tmp_hst&0xff,(trg.tmp_hst>>8)&0xff,trg.hm_hst&0xff,(trg.hm_hst>>8)&0xff]);
			}
		} else {
			trg.tmp_hst = Math.round(10.0 * parseFloat($("trg_tmp_hst").value));
			trg.hm_hst = Math.round(10.0 * parseFloat($("trg_hm_hst").value));
			addClog("Send cmd (44 + trg data)...");
			blk = new Uint8Array([0x44, trg.tmp_thr&0xff, (trg.tmp_thr>>8)&0xff,trg.hm_thr&0xff,(trg.hm_thr>>8)&0xff,trg.tmp_hst&0xff,trg.hm_hst&0xff]);
		}
		settingsCharacteristics.writeValue(blk).then(_ => {	addAlog('Send Trg data: '+dump(blk, blk.length)+' -ok');});
	}
}
function sendDeltaTime() {
	let dtim = parseInt($("cfg_time_step").value);
	if(dtim > -32768 && dtim < 32768) {
		addClog("Send cmd set delta (24 + delta: '+dtim+' )...");
		settingsCharacteristics.writeValue(new Uint8Array([0x24, dtim&0xff, (dtim>>8)&0xff])).then(_ => {
			addAlog('Send delta time ok');
			setDevTime();
		});
	} else {
		addAlog("Delta time -32767 to 32767!");
	}
}
function sendGetMemo(cnt) {
	let count = cnt & 0x7fff;
	let start = 0;
	if(count > 19632) count = 19632;
	if(start < 0) start = 0;
	else if(start >= count) start = count - 1;
	blk = new Uint8Array([0x35, count&0xff, (count>>8)&0xff,start&0xff,(start>>8)&0xff]);
	addClog("Send cmd GetMemo: ("+dump(blk, blk.length)+")...");
	settingsCharacteristics.writeValue(blk).then(_ => {
		flg_memo_act = true;
		addAlog('Send cmd GetMemo ok');
	});
}
function getBKey() {
		settingsCharacteristics.writeValue(new Uint8Array([0x18])).then(_ => {
			addAlog('Get binkey from EEP...');
		});
}
function setBKey() {
	let bk = $("cbind_key").value;
	if(bk.length == 32) {
		let bkey = hexToBytes(bk);
		if(bkey.length == 16) {
			let blk = new Uint8Array(17);
			blk.set(bkey,1);
			blk[0] = 0x18;
			addClog("Send bindkey to EEP...");
			settingsCharacteristics.writeValue(blk).then(_ => {
				addAlog("Send new bindkey: " + bytesToHex(blk.slice(1)));
			});
			return;
		}
	}
	addLog("BindKey must be 16 hex digits!")
}
function InfoIntervals() {
		let advn = parseFloat($("cfg_adv_int").value);
		let meas = parseInt($("cfg_meas_int").value);
		if(advn != 0 && meas != 0) {
			advn = Math.round(advn/62.5) * 62.5;
			$("cfg_meas_int_val").innerHTML = "= " + String((advn * meas / 1000).toFixed(1)) + " sec";
			if(cfg.ver >= 0x20) {
				let memo = parseInt($("cfg_av_meas_mem").value);
				if(memo != 0) {
					let x = advn * meas * memo / 1000;
					if (x < 60)
						$("cfg_av_meas_mem_val").innerHTML = "= " +	 String(x.toFixed(1)) + " sec";
					else
						$("cfg_av_meas_mem_val").innerHTML = "= " +	 String(x.toFixed(1)) + " sec = " + String((x / 60).toFixed(1)) + " min";
				}
			}
		}
}
function CustomConfig() {
  menuUpgrade();
  let is = '';
  if(cfg.ver >= 0x10) {
	is = '<hr>Send commands to custom firmware:<br><input type="text" id="cmdTXT" value=""><button type="button" onclick="sendCustomSetting($(&quot;cmdTXT&quot;).value,settingsCharacteristics);">Send</button>';
	if(hwver_id == 0)
		is += ' Test: [ <button type="button" onclick="lcd_clock();">Show clock on LCD</button> <button type="button" onclick="lcd_restore();">Repair LCD</button> ]<br>';
	is += '<br>Show on device screen:<br>';
	if(hwver_id == 2 || hwver_id == 6 || hwver_id == 7){
		is += '<input size="6" title="Big number: -99.5..1999.5" id="extbignumb" maxlength="5" value="123.4">';
		is += ' <select id="exttmpsmb"><option value="0">&nbsp;&nbsp;</option><option value="1">°Г</option><option value="2">&nbsp;-</option><option value="3">°F</option><option value="4">&nbsp;_</option><option value="5">°C</option><option value="6" selected>&nbsp;=</option><option value="7">°E</option></select>';
		is += ' <select id="extsmiley"><option value="0" selected>&nbsp;&nbsp;&nbsp;</option><option value="5">&nbsp;---&nbsp;</option></select>';
		is += '	<input size="5" title="Small number: -99.5..999.5" id="extsmalnumb" maxlength="5" value="56.7">';
	}else if(hwver_id == 9){
		is += '<input size="8" title="Big number: -999.50..19999.50" id="extbignumb" maxlength="8" value="123.45">';
		is += ' <select id="exttmpsmb"><option value="0">&nbsp;&nbsp;</option><option value="1">°г</option><option value="2">&nbsp;-</option><option value="3">°C</option><option value="4">&nbsp;i</option><option value="5">°Г</option><option value="6" selected>&nbsp;г</option><option value="7">°F</option></select>';
		is += ' <select id="extsmiley"><option value="0">&nbsp;&nbsp;&nbsp;</option><option value="1">&nbsp;^_^&nbsp;</option><option value="2">&nbsp;-&and;-&nbsp;</option><option value="3">&nbsp;&Delta;&#9651;&Delta;&nbsp;</option><option value="4">(&nbsp;&nbsp;&nbsp;)</option><option value="5">(^_^)</option><option value="6">(-&and;-)</option><option value="7" selected>(&Delta;&#9651;&Delta;)</option></select>';
	}else{
		is += '<input size="6" title="Big number: -99.5..1999.5" id="extbignumb" maxlength="5" value="123.4">';
		is += ' <select id="exttmpsmb"><option value="0">&nbsp;&nbsp;</option><option value="1">°Г</option><option value="2">&nbsp;-</option><option value="3">°F</option><option value="4">&nbsp;_</option><option value="5">°C</option><option value="6" selected>&nbsp;=</option><option value="7">°E</option></select>';
		is += ' <select id="extsmiley"><option value="0">&nbsp;&nbsp;&nbsp;</option><option value="1">&nbsp;^_^&nbsp;</option><option value="2">&nbsp;-&and;-&nbsp;</option><option value="3">&nbsp;&Delta;&#9651;&Delta;&nbsp;</option><option value="4">(&nbsp;&nbsp;&nbsp;)</option><option value="5">(^_^)</option><option value="6">(-&and;-)</option><option value="7" selected>(&Delta;&#9651;&Delta;)</option></select>';
		is += '	<input size="5" title="Small number: -9..99" id="extsmalnumb" maxlength="2" value="99">';
	}
	is += '&nbsp;%<input type="checkbox" id="extpersent">';
	is += '	<input size="5" title="Validity time = Show time in sec: 1..65535" id="extvtimed" maxlength="5" value="600">';
	is += '&nbsp;Battery:<input type="checkbox" id="extbattery">';
	is += '	<button type="button" onclick="sendCustomSetting(&quot;22&quot;);">Get OldData</button>';
	is += '	<button type="button" id="extsend" onclick="sendExt();">Show</button>';
	ext.enable = true;
	is += '<br><br><hr><br><b>Configuration:</b>&nbsp;<button type="button" onclick="sendCustomSetting(&quot;55&quot;);">Get Config</button><br><br>';
	if(cfg.ver >= 0x43)
		is += 'Screen Off: <input title="Screen Off" type="checkbox" id="cfg_scr_off"><br><br>';
	is += 'Temperature: <select id="cfg_flg_cf"><option value="0">°C</option><option value="1">°F</option></select>';
	if(hwver_id == 9)
		is += '&nbsp;&nbsp;12-hour clock:<input type="checkbox" id="cfg_flg_am_pm">&nbsp;&nbsp;T&H 2 decimal places<input type="checkbox" id="cfg_flg_x100">';
	is += '<br><br>';
	if((hwver_id == 2)||(hwver_id == 6)||(hwver_id == 7))
		is += 'Line: <select id="cfg_smiley"><option value="0" selected>&nbsp;&nbsp;&nbsp;</option><option value="5">&nbsp;---&nbsp;</option></select>';
	else if(hwver_id == 9)
		is += 'Show: <select id="cfg_scr_type"><option value="0">Time</option><option value="1">Temperature</option><option value="2">Humidity</option><option value="3">Battery %</option><option value="4">Battery V</option><option value="5">ExtNumber&Symbols</option></select>';
	else
		is += 'Smiley: <select id="cfg_smiley"><option value="0">&nbsp;&nbsp;&nbsp;</option><option value="1">&nbsp;^_^&nbsp;</option><option value="2">&nbsp;-&and;-&nbsp;</option><option value="3">&nbsp;&Delta;&#9651;&Delta;&nbsp;</option><option value="4">(&nbsp;&nbsp;&nbsp;)</option><option value="5">(^_^)</option><option value="6">(-&and;-)</option><option value="7">(&Delta;&#9651;&Delta;)</option></select>';
	is += ', Comfort: <input type="checkbox" id="cfg_flg_comfort">';
	if(hwver_id != 9)
		is += ', Show batt: <input type="checkbox" id="cfg_flg_show_batt">';
	if(cfg.ver >= 0x18) {
		if(hwver_id != 9)
			is += ', Clock: <input type="checkbox" id="cfg_flg_blinking"> ';
		is += '<button type="button" onclick="setDevTime();">Set Time</button> <button type="button" onclick="sendCustomSetting(&quot;23&quot;);">Get Time</button>';
	}else
		is += ', Blinking: <input type="checkbox" id="cfg_flg_blinking">';
	is += '<br><br>Sensor in "LowPower mode": <input title="Sensor measurements in Low Power mode" type="checkbox" id="cfg_flg_lp_meas">';
	is += ', Tx measures: <input title="When connected, start transferring measurements" type="checkbox" id="cfg_flg_tx_meas">';
	is += ' <button type="button" title="Start transferring measurements. Only in the current connection." onclick="sendCustomSetting(&quot;33ff&quot;);">Start Tx Measure</button>';
	is += ' <button type="button" title="Stop transferring measurements. Only in the current connection." onclick="sendCustomSetting(&quot;3300&quot;);">Stop Tx Measure</button><br><br>';
	is += 'Temperature offset: <input size="5" title="-12.7..12.7°, default 0" id="cfg_tmp_off" maxlength="5" value="0"> °';
	is += ', Humidity offset: <input size="5" title="-12.7..12.7%, default 0" id="cfg_hm_off" maxlength="5" value="0"> %<br><br>';
	if(cfg.ver >= 0x36) {
		if(cfg.ver >= 0x42)
			is += 'BT5+ PHY: <input title="Support BT5.0+ PHY (LE 2M/1M/500K/125K, CSA2)" type="checkbox" id="bt5_flags">, LE Long Range (only for BT5.0+ adapters!): <input title="Enable Extended Advertising Long Range (Coded PHY S8)" type="checkbox" id="longrange_flags"><br><br>';
		else if(cfg.ver >= 0x40)
			is += 'BT5+ PHY: <input title="Support BT5.0+ PHY (LE 2M/1M/500K/125K, CSA2)" type="checkbox" id="bt5_flags"><br><br>';
		else
			is += 'BT5+ PHY: <input title="Support BT5.0+ PHY (LE 2M/1M/500K/125K)" type="checkbox" id="bt5_flags">, CSA2: <input title="Channel Selection Algorithm 2 or 1" type="checkbox" id="csa2_flags"><br><br>';
	}
	is += 'Advertising type: <select id="cfg_flg_adv_type"><option value="0">ATC1441</option><option value="1">PVVX (Custom)</option><option value="2">MIJIA (MiHome)</option><option value="3" selected>';
	if(cfg.ver >= 0x37)
		is += 'BTHome v1</option></select>';
	else
		is += 'All</option></select>';
	if(cfg.ver >= 0x30)
		is += ', AdFlags: <input title="Toggle support for third-party software" type="checkbox" id="adv_flags">';
	if(cfg.ver >= 0x22)
		is += ', Encrypted beacon: <input title="Bindkey encrypted beacon" type="checkbox" id="cfg_adv_crypto">';
	is += '<br><br>Advertising interval: <input size="5" title="62.5 ms .. 10 000 ms, step: 62.5 ms, default 2500 ms" id="cfg_adv_int" maxlength="6" value="40"> ms, step: 62.5 ms<br><br>';
	is += 'Measure interval: <input size="5" title="1..25 (62.5 ms .. 250 sec), default 4 (10 sec)" id="cfg_meas_int" maxlength="2" value="4"> x(Advertising interval) <span id="cfg_meas_int_val"></span><br><br>';
	if(cfg.ver > 0x40)
		is += 'Connect latency: <input size="5" title="0..1000 ms, default 1000 ms" id="cfg_con_lat" maxlength="4" value="1000"> ms, step 20 ms<br><br>';
	else
		is += 'Connect latency: <input size="5" title="0..4000 ms, default 2500 ms" id="cfg_con_lat" maxlength="4" value="2500"> ms, step 20 ms<br><br>';
	if(MAX_RF_TX_Power) is += 'RF TX Power: <select id="cfg_rf_tx"><option value="63">VBAT+10.46 dbm</option><option value="61">VBAT+10.29 dbm</option><option value="58">VBAT+10.01 dbm</option><option value="56">VBAT+9.81 dbm</option><option value="53">VBAT+9.48 dbm</option><option value="51">VBAT+9.24 dbm</option><option value="49">VBAT+8.97 dbm</option><option value="47">VBAT+8.73 dbm</option><option value="45">VBAT+8.44 dbm</option><option value="43">VBAT+8.13 dbm</option><option value="41">VBAT+7.79 dbm</option><option value="39">VBAT+7.41 dbm</option><option value="37">VBAT+7.02 dbm</option><option value="35">VBAT+6.60 dbm</option><option value="33">VBAT+6.14 dbm</option><option value="31">VBAT+5.65 dbm</option><option value="29">VBAT+5.13 dbm</option><option value="27">VBAT+4.57 dbm</option><option value="25">VBAT+3.94 dbm</option><option value="23">VBAT+3.23 dbm</option><option value="191" selected>VANT+3.01 dbm</option><option value="189">VANT+2.81 dbm</option><option value="187">VANT+2.61 dbm</option><option value="185">VANT+2.39 dbm</option><option value="182">VANT+1.99 dbm</option><option value="180">VANT+1.73 dbm</option><option value="178">VANT+1.45 dbm</option><option value="176">VANT+1.17 dbm</option><option value="174">VANT+0.90 dbm</option><option value="172">VANT+0.58 dbm</option><option value="169">VANT+0.04 dbm</option><option value="168">VANT-0.14 dbm</option><option value="164">VANT-0.97 dbm</option><option value="162">VANT-1.42 dbm</option><option value="160">VANT-1.89 dbm</option><option value="158">VANT-2.48 dbm</option><option value="156">VANT-3.03 dbm</option><option value="154">VANT-3.61 dbm</option><option value="152">VANT-4.26 dbm</option><option value="150">VANT-5.03 dbm</option><option value="148">VANT-5.81 dbm</option><option value="146">VANT-6.67 dbm</option><option value="144">VANT-7.65 dbm</option><option value="142">VANT-8.65 dbm</option><option value="140">VANT-9.89 dbm</option><option value="138">VANT-11.4 dbm</option><option value="136">VANT-13.29 dbm</option><option value="134">VANT-15.88 dbm</option><option value="132">VANT-19.27 dbm</option><option value="130">VANT-25.18 dbm</option></select><br><br>';
	else is += 'RF TX Power: <select id="cfg_rf_tx"><option value="191" selected>VANT+3.01 dbm</option><option value="189">VANT+2.81 dbm</option><option value="187">VANT+2.61 dbm</option><option value="185">VANT+2.39 dbm</option><option value="182">VANT+1.99 dbm</option><option value="180">VANT+1.73 dbm</option><option value="178">VANT+1.45 dbm</option><option value="176">VANT+1.17 dbm</option><option value="174">VANT+0.90 dbm</option><option value="172">VANT+0.58 dbm</option><option value="169">VANT+0.04 dbm</option><option value="168">VANT-0.14 dbm</option><option value="164">VANT-0.97 dbm</option><option value="162">VANT-1.42 dbm</option><option value="160">VANT-1.89 dbm</option><option value="158">VANT-2.48 dbm</option><option value="156">VANT-3.03 dbm</option><option value="154">VANT-3.61 dbm</option><option value="152">VANT-4.26 dbm</option><option value="150">VANT-5.03 dbm</option><option value="148">VANT-5.81 dbm</option><option value="146">VANT-6.67 dbm</option><option value="144">VANT-7.65 dbm</option><option value="142">VANT-8.65 dbm</option><option value="140">VANT-9.89 dbm</option><option value="138">VANT-11.4 dbm</option><option value="136">VANT-13.29 dbm</option><option value="134">VANT-15.88 dbm</option><option value="132">VANT-19.27 dbm</option><option value="130">VANT-25.18 dbm</option></select><br><br>';
	if(hwver_id != 9)
		is += 'Minimum LCD refresh rate: <input size="5" title="0.5..12.75 sec, step: 0.05 s, default 2.45 s" id="cfg_lcd_tint" maxlength="6" value="2.45"> s, step: 0.05 s<br><br>';
	if(cfg.ver == 0x19) {
		is += 'Recording measurements to flash memory <input type="checkbox" id="cfg_flg2_memo" title="Recording measurements to flash memory (cyclic buffer for 19632 measurements)">';
		is += ' <button type="button" onclick="sendGetMemo(50);">Get the last 50 records</button> <a href="GraphMemo.html">GraphMemo.html</a><br><br>';
	}
	if(cfg.ver >= 0x20) {
		is += 'Recording averaging measurements to flash memory <input size="5" title="0..255, =0 - off, default 60. Set time/date!" id="cfg_av_meas_mem" maxlength="3" value="60"> x(measure interval) <span id="cfg_av_meas_mem_val"></span><br>';
		if(cfg.ver >= 0x23)
			is += '<button type="button" onclick="sendCustomSetting(&quot;361234&quot;);">!Delete all records!</button> '
		is += '<a href="GraphMemo.html">GraphMemo.html</a> <button type="button" onclick="setDevTime();">Set Time</button> <button type="button" onclick="sendGetMemo(50);">Get the last 50 records</button><br><br>';
	}
	is += '<button type="button" onclick="SendCustomConfig()">Send Config</button>';
	is += ' <button type="button" onclick="sendCustomSetting(&quot;56&quot;);">Set default</button><br>';
	if(cfg.ver >= 0x24 && hwver_id != 9) {
		is += '<hr><button type="button" title="Get time clock delta" onclick="sendCustomSetting(&quot;24&quot;);">Get delta time</button>';
		is += ' Adjust time clock delta: <input size="5" title="-32767..32767, in 1/16 us for 1 sec, default 0" id="cfg_time_step" maxlength="6" value="0">';
		is += ' <button type="button" onclick="sendDeltaTime();">Set delta time</button>';
		if(cfg.ver >= 0x36)
			is += ' <button type="button" title="The minimum period for calculation is 3 hours!" onclick="calkDeltaTime();">Calk delta time</button><br>';
		else
			is += '<br>';
	}
	if((hwver_id == 0)||(hwver_id == 3)||(hwver_id == 4)||(hwver_id == 5)||(hwver_id == 10))
		is += '<hr><b>Management GPIO_TRG</b> (mark "reset"):';
	else
		is += '<hr><b>Management GPIO_TRG:</b>';
	is += '&nbsp;<button type="button" title="Get/read current setings" onclick="sendCustomSetting(&quot;44&quot;);">Get TRG</button><br>';
	if(cfg.ver >= 0x26) {
		is += 'Temperature hysteresis: <input size="8" title="Step 0.01°, default -0.55°, =0 off, if less than zero - activation on decrease, if more than zero - activation on excess" id="trg_tmp_hst" maxlength="7" value="-0.55"> °';
		is += ', Humidity hysteresis: <input size="8" title="Step 0.01%, default 0, =0 off, if less than zero - activation on decrease, if more than zero - activation on excess" id="trg_hm_hst" maxlength="7" value="0.0"> %<br>';
	} else {
		is += 'Temperature hysteresis: <input size="8" title="-12.7..12.7°, default -0.1, =0 off, if less than zero - activation on decrease, if more than zero - activation on excess" id="trg_tmp_hst" maxlength="5" value="-0.1"> °';
		is += ', Humidity hysteresis: <input size="8" title="-12.7..12.7%, default 0, =0 off, if less than zero - activation on decrease, if more than zero - activation on excess" id="trg_hm_hst" maxlength="5" value="0.0"> %<br>';
	}
	is += 'Temperature threshold: <input size="8" title="-40.00..80.00°C, default 21.00°C" id="trg_tmp_thr" maxlength="6" value="21.00"> °';
	is += ', Humidity threshold: <input size="8" title="0..99.00%, default 50.00%" id="trg_hm_thr" maxlength="6" value="50.00"> %<br><br>';
	if(cfg.ver >= 0x37) {
		is += '<b>Management GPIO_RS (Reed Switch):</b><br><br>';
		is += 'RS mode: <select id="rds_type"><option value="0" selected>None</option><option value="1">Switch</option><option value="2">Counter</option>';
		if(cfg.ver >= 0x42 && hwver_id != 9)
			is += '<option value="3" selected>Connect</option>';
		if(cfg.ver >= 0x39)	is += '</select>, Invert RS event: <input type="checkbox" id="rds_invert">';
		is += '<br>RS report interval: <input size="8" title="0 - Off, 1..65535 sec, default 3600 sec" id="rds_rpint" maxlength="6" value="3600"> sec';
	}
	is += '<br> <button type="button" title="Set/save current setings" onclick="sendTrg();">Set TRG</button>';
	is += ' <button type="button" title="GPIO_TRG PullUp 10 kOm. Work only TRG off!" onclick="sendCustomSetting(&quot;4501&quot;);">Set pin to "1"</button>';
	is += ' <button type="button" title="GPIO_TRG PullDown 100 kOm. Work only TRG off!" onclick="sendCustomSetting(&quot;4500&quot;);">Set pin to "0"</button><br><hr>';
	if(cfg.ver >= 0x13) {
		is += '<b>Comfort parameters:</b>&nbsp;';
		is += '<button type="button" title="Get current comfort parameters. The parameters are processed if the configuration is set to &quot;Comfort: On&quot;." onclick="sendCustomSetting(&quot;20&quot;);">Get current comfort parameters</button><br>';
		is += 'Temperature Lo:<input size="8" title="-40.00..125.00°C, default 21.00°C" id="cmf_tmp_lo" maxlength="6" value="21.00">, ';
		is += 'Hi: <input size="8" title="-40.00..125.00°C, default 26.00°C" id="cmf_tmp_hi" maxlength="6" value="26.00"> °C<br>';
		is += 'Humidity Lo:<input size="8" title="0.0..99.99%, default 30.00" id="cmf_hm_lo" maxlength="5" value="30.00">, ';
		is += 'Hi:<input size="8" title="0.0..99.99%, default 60.00%" id="cmf_hm_hi" maxlength="5" value="60.00"> %<br>';
		is += '<button type="button" title="Set comfort parameters" onclick="SendCmf();">Set comfort parameters</button><br><hr>';
		cmf.enable = true;
	}
	trg.enable = true;
	is += '<b>Keys and Codes:</b>&nbsp;<button type="button" onclick="sendCustomSetting(&quot;15&quot;);">Show all mi keys</button><br>';
	if(cfg.ver >= 0x11) {
		is += '<input size="6" maxlength="6" type="text" title="000000..999999, 6 decimal digits, 000000 - PinCode Disable. Warning: If the PinCode is forgotten - only a hardware flasher!" id="pincode" value="000000"> <button title="Warning: If the PinCode is forgotten - only a hardware flasher!" type="button" onclick="sendPinCode();">!Set PinCode!</button><br>';
		pincode.enable = true;
		if(cfg.ver >= 0x14) {
			is += '<br><button type="button" onclick="sendCustomSetting(&quot;01&quot;);">Get device Name</button> <input size="10" maxlength="10" type="text" title="Device Name: 1..10 chars" id="dev_name" value=""> <button type="button" title="Set New Name" onclick="sendDevName();">Set New Name</button> <button title="Clean Name: ATC_xxxx" type="button" onclick="CleanDevName();">Set default Name</button><br>';
			dnm.enable = true;
		}
	}

	if(mikeys.mac) {
		is +='Device MAC [+ 2 Rand]:<br><input size="40" maxlength="16" type="text" id="mi_mac" title="Must be 6 hex MAC digits [+ 2 hex RandMAC digits]!" value="'+hex(mikeys.mac[5],2)+hex(mikeys.mac[4],2)+hex(mikeys.mac[3],2)+hex(mikeys.mac[2],2)+hex(mikeys.mac[1],2)+hex(mikeys.mac[0],2)+hex(mikeys.mac[7],2)+hex(mikeys.mac[6],2)+'">';
		// ', C0'+hex(mikeys.mac[7],2)+hex(mikeys.mac[6],2)+hex(mikeys.mac[2],2)+hex(mikeys.mac[1],2)+hex(mikeys.mac[0],2)'
		if(cfg.ver >= 0x14)
			is +=' <button type="button" title="Set Custom MAC. Warning: If the pin code is set, restart all Soft & Hard for the next connection!" onclick="sendMAC();">!Set MAC!</button> <button type="button" title="Clean MAC - Set Standart Random MAC: A4C138******. Warning: If the pin code is set, restart all Soft & Hard for the next connection!" onclick="CleanMAC();">!Clean MAC!</button>';
		is +='<br>';
	}
	if(mikeys.id) {
		let str = new TextDecoder("utf-8").decode(mikeys.id.slice(1));
		is +='Device known id:<br><input size="40" maxlength="19" type="text" id="known_id" value="'+str+'"><br>';
	}
	if(mikeys.bindkey && mikeys.token) {
		is +='Mi Token:<br><input size="40" maxlength="24" type="text" id="mi_token" value="'+dump(mikeys.token,12)+'"><br>';
		is +='Mi Bind Key:<br><input size="40" maxlength="32" type="text" id="mi_bind_key" value="'+dump(mikeys.bindkey,16)+'">';
		is +=' <button type="button" title="Set new Mi Token and Bind keys" onclick="setNewTBKey();">Set new Token & Bind keys</button><br>';
		if(cfg.ver >= 0x21)
			is +=' <button type="button" title="Erase all MiKeys" onclick="sendCustomSetting(&quot;17&quot;);">!Erase all Mi Keys!</button>';
		if(mikeys.restore) {
			is += '<br><button type="button" onclick="sendCustomSetting(&quot;16&quot;);">Swap previous token + bindkey</button>';
		}
		is += '<br>';
	}
	if(cfg.ver >= 0x28) {
		is +='EEP BindKey:<br><input size="40" maxlength="32" title="Bind Key must be 16 hex digits" type="text" id="cbind_key" value="?">';
		is +=' <button type="button" title="Get EEP BindKey" onclick="getBKey();">Get EEP BindKey</button>';
		is +=' <button type="button" title="Set new EEP BindKey" onclick="setBKey();">Set EEP BindKey</button><br>';
	}
	$("custcfg").innerHTML = is;
	if(cfg.ver >= 0x43)
		$("cfg_scr_off").checked = (cfg.flg2&0x80) != 0
	$("cfg_flg_adv_type").value = cfg.flg&3;
	$("cfg_flg_comfort").checked = (cfg.flg&4) != 0;
	if(hwver_id == 9) {
		$("cfg_flg_am_pm").checked = (cfg.flg&32) != 0;
		$("cfg_flg_x100").checked = (cfg.flg&8) != 0;
		$("cfg_scr_type").value = cfg.flg2&7;
		$("adv_flags").checked = (cfg.flg2&0x10) != 0;
		$("bt5_flags").checked = (cfg.flg2&0x20) != 0;
		$("longrange_flags").checked = (cfg.flg2&0x40) != 0;
	} else {
		$("cfg_flg_blinking").checked = (cfg.flg&8) != 0;
		$("cfg_flg_show_batt").checked = (cfg.flg&32) != 0;
		$("cfg_smiley").value = cfg.flg2&7;
		if(cfg.ver == 0x19)
			$("cfg_flg2_memo").checked = (cfg.flg2&8) != 0;
		if(cfg.ver >= 0x30)
			$("adv_flags").checked = (cfg.flg2&0x10) != 0;
		if(cfg.ver >= 0x36) {
			$("bt5_flags").checked = (cfg.flg2&0x20) != 0;
			if(cfg.ver >= 0x42)
				$("longrange_flags").checked = (cfg.flg2&0x40) != 0;
			else if(cfg.ver < 0x40)
				$("csa2_flags").checked = (cfg.flg2&0x40) != 0;
		}
		$("cfg_lcd_tint").value = String((cfg.lcd_tint * 0.05).toFixed(2));
	}
	$("cfg_flg_cf").value = ((cfg.flg&16) != 0 ? 1 : 0);
	$("cfg_flg_tx_meas").checked = (cfg.flg&64) != 0;
	$("cfg_flg_lp_meas").checked = (cfg.flg&128) != 0;
	if(cfg.ver >= 0x22)
		$("cfg_adv_crypto").checked = (cfg.flg2&0x08) != 0;
	if(cfg.ver >= 0x20) {
		$("cfg_av_meas_mem").value = String(cfg.av_meas_mem);
		$("cfg_av_meas_mem").onchange = function() {InfoIntervals();}
	}
	$("cfg_tmp_off").value = String((cfg.temp_offset / 10.0).toFixed(1));
	$("cfg_hm_off").value = String((cfg.humi_offset / 10.0).toFixed(1));
	$("cfg_adv_int").value = String((cfg.advertising_interval * 62.5).toFixed(1));
	$("cfg_adv_int").onchange = function() {InfoIntervals();}
	$("cfg_meas_int").value = String(cfg.measure_interval);
	$("cfg_meas_int").onchange = function() {InfoIntervals();}
	$("cfg_rf_tx").value = String(cfg.rf_tx_power);
	$("cfg_con_lat").value = String((cfg.connect_latency + 1) * 20);
	InfoIntervals();
	cfg.enable = true;
  } else
	$("custcfg").innerHTML = '<hr><br><br>Unsupported device software version! Custom ATC version >= 1.0!<br><br>';
}
function hex(number, len) {
	var str = (number.toString(16)).toUpperCase();
	while (str.length < len) str = '0' + str;
	return str;
}
function SendCustomConfig() {
	if(hwver_id != 9) {
		cfg.flg = ($("cfg_flg_adv_type").value & 3)+
		(($("cfg_flg_comfort").checked) ? 4 : 0) +
		(($("cfg_flg_blinking").checked) ? 8 : 0) +
		(($("cfg_flg_cf").value != 0) ? 16 : 0) +
		(($("cfg_flg_show_batt").checked) ? 32 : 0) +
		(($("cfg_flg_tx_meas").checked) ? 64 : 0) +
		(($("cfg_flg_lp_meas").checked) ? 128 : 0);
		cfg.flg2 = (parseInt($("cfg_smiley").value) & 7);
		if(cfg.ver == 0x19)
			cfg.flg2 += (($("cfg_flg2_memo").checked) ? 8 : 0);
		if(cfg.ver >= 0x22)
			cfg.flg2 += (($("cfg_adv_crypto").checked) ? 0x08 : 0);
		if(cfg.ver >= 0x30)
			cfg.flg2 += (($("adv_flags").checked )? 0x10 : 0);
		if(cfg.ver >= 0x36) {
			cfg.flg2 += (($("bt5_flags").checked) ? 0x20 : 0);
			if(cfg.ver >= 0x42) {
				cfg.flg2 += (($("longrange_flags").checked) ? 0x40 : 0);
				if(cfg.ver >= 0x43)
					cfg.flg2 += (($("cfg_scr_off").checked) ? 0x80 : 0);
			} else if(cfg.ver < 0x40)
				cfg.flg2 += (($("csa2_flags").checked) ? 0x40 : 0);
		}
		cfg.lcd_tint = Math.round(parseFloat($("cfg_lcd_tint").value) / 0.05);
		if(cfg.lcd_tint < 10) cfg.lcd_tint = 10;
		else if(cfg.lcd_tint > 255) cfg.lcd_tint = 255;
	} else {
		cfg.flg = ($("cfg_flg_adv_type").value & 3)+
		(($("cfg_flg_comfort").checked) ? 4 : 0) +
		(($("cfg_flg_x100").checked != 0) ? 8 : 0) +
		(($("cfg_flg_cf").value != 0) ? 16 : 0) +
		(($("cfg_flg_am_pm").checked) ? 32 : 0) +
		(($("cfg_flg_tx_meas").checked) ? 64 : 0) +
		(($("cfg_flg_lp_meas").checked) ? 128 : 0);
		cfg.flg2 = (parseInt($("cfg_scr_type").value) & 7);
		cfg.flg2 += (($("cfg_adv_crypto").checked) ? 0x08 : 0);
		cfg.flg2 += (($("adv_flags").checked )? 0x10 : 0);
		cfg.flg2 += (($("bt5_flags").checked) ? 0x20 : 0);
		cfg.flg2 += (($("longrange_flags").checked) ? 0x40 : 0);
		if(cfg.ver >= 0x43)
			cfg.flg2 += (($("cfg_scr_off").checked) ? 0x80 : 0);
	}
	if(cfg.ver >= 0x20)	cfg.av_meas_mem = parseInt($("cfg_av_meas_mem").value);
	cfg.temp_offset = Math.round(10.0 * parseFloat($("cfg_tmp_off").value));
	if(cfg.temp_offset < -127) cfg.temp_offset = -127;
	else if(cfg.temp_offset > 127) cfg.temp_offset = 127;
	cfg.humi_offset = Math.round(10.0 * parseFloat($("cfg_hm_off").value));
	if(cfg.humi_offset < -127) cfg.humi_offset = -127;
	else if(cfg.humi_offset > 127) cfg.humi_offset = 127;
	cfg.advertising_interval = Math.round(parseFloat($("cfg_adv_int").value) / 62.5)
	if(cfg.advertising_interval < 1) cfg.advertising_interval = 1;
	else if(cfg.advertising_interval > 160) cfg.advertising_interval = 160;
	cfg.measure_interval = parseInt($("cfg_meas_int").value);
	if(cfg.measure_interval < 1) cfg.measure_interval = 1;
	else if(cfg.measure_interval > 25) cfg.measure_interval = 25;
	cfg.rf_tx_power = parseInt($("cfg_rf_tx").value);
	if(cfg.rf_tx_power&0x80) { /*VANT*/
		if(cfg.rf_tx_power > 191) cfg.rf_tx_power = 191;
		else if(cfg.rf_tx_power < 130) cfg.rf_tx_power = 130;
	} else { /*VBAT*/
		if(cfg.rf_tx_power < 23) cfg.rf_tx_power = 23;
		else if(cfg.rf_tx_power > 63) cfg.rf_tx_power = 63;
	}
	cfg.connect_latency = Math.round((parseFloat($("cfg_con_lat").value) / 20.0) - 1);
	if(cfg.connect_latency < 0) cfg.connect_latency = 0;
	else {
	  if(cfg.ver > 0x40)
		  if(cfg.connect_latency > 49) cfg.connect_latency = 49;
	  else
		  if(cfg.connect_latency > 200) cfg.connect_latency = 200;
	}
	if(cfg.ver < 0x20) {
		let s = 'New custom config: ['+cfg.flg+', '+cfg.flg2+', '+cfg.temp_offset+', '+cfg.humi_offset+', '+cfg.advertising_interval+', '+cfg.measure_interval+', '+cfg.rf_tx_power+', '+cfg.connect_latency+', '+cfg.lcd_tint+']';
		addAlog(s);
		sendCustomSetting('55'+hex(cfg.flg,2)+hex(cfg.flg2,2)+hex(cfg.temp_offset&0xff,2)+hex(cfg.humi_offset&0xff,2)+hex(cfg.advertising_interval,2)+hex(cfg.measure_interval,2)+hex(cfg.rf_tx_power,2)+hex(cfg.connect_latency,2)+hex(cfg.lcd_tint,2));
	} else {
		let s = 'New custom config: ['+cfg.flg+', '+cfg.flg2+', '+cfg.temp_offset+', '+cfg.humi_offset+', '+cfg.advertising_interval+', '+cfg.measure_interval+', '+cfg.rf_tx_power+', '+cfg.connect_latency+', '+cfg.lcd_tint+', '+cfg.hver+', '+cfg.av_meas_mem+']';
		addAlog(s);
		sendCustomSetting('55'+hex(cfg.flg,2)+hex(cfg.flg2,2)+hex(cfg.temp_offset&0xff,2)+hex(cfg.humi_offset&0xff,2)+hex(cfg.advertising_interval,2)+hex(cfg.measure_interval,2)+hex(cfg.rf_tx_power,2)+hex(cfg.connect_latency,2)+hex(cfg.lcd_tint,2)+hex(cfg.hver,2)+hex(cfg.av_meas_mem,2));
	}
	$("custcfg").innerHTML = '<hr><button type="button" onclick="sendCustomSetting(&quot;55&quot;);">Get Config</button><br>Send commands to custom firmware:<br><input type="text" id="cmdTXT" value=""><button type="button" onclick="sendCustomSetting($(&quot;cmdTXT&quot;).value,settingsCharacteristics);">Send</button><br>';
}
</script>
<h1>Telink Flasher to convert Xiaomi Bluetooth sensors to Zigbee</h1>
<div class="navbar">
	<div class="container nav-container">
		<input class="checkbox" type="checkbox" name="" id="">
		<div class="hamburger-lines">
		  <span class="line line1"></span>
		  <span class="line line2"></span>
		  <span class="line line3"></span>
		</div>
	  <div class="menu-items">
			<li> GitHub </li>
			<li><a href="https://github.com/atc1441/ATC_MiThermometer">© atc1441</a> <a href="https://github.com/pvvx/ATC_MiThermometer">&#9432; pvvx</a></li>
			<li> Live Data </li>
			<li><a href="GraphAtc.html">Graph Atc 1</a></li>
			<li><a href="GraphAtc1.html">Graph Atc 2</a></li>
			<li><a href="GraphAtc2.html">Graph Atc 3</a></li>
			<li><a href="DevPoint.html">Dev Point</a></li>
			<li><a href="Advertising.html">Advertising</a></li>
			<li>Stored data</li>
			<li><a href="GraphMemo.html">Memo Graph</a></li>
			<li><a href="GraphMemoOriginal.html">LYWSD03MMC Memo Graph </a></li>
			<li>Others & Flasher</li>
			<li><a href="TelinkMiFlasher.html">Flasher</a></li>
			<li><a href="TelinkOTA.html">OTA Flasher</a></li>
			<li><a href="USBCOMFlashTx.html">Windows USB-COM Flasher</a></li>
	  </div>
	</div>
</div>
<hr>
<!-- Copyright: Aaron Christophel / Atc1441	 <a href="https://atcnetz.de">https://ATCnetz.de</a><br> -->
<div style="height: auto; width: auto;">
  <input type="checkbox" title="Web Experimental Features!" id="advmac">
  <label for="advmac">Get Advertising MAC</label>
  <br>
  <label for="namePrefix">BLE device name prefix filter(s)</label>
  <input type="text" id="namePrefix" value="" placeholder="LYWSD03,ATC"><br>
  <button type="button" onclick="connect();">Connect</button>
  <button type="button" onclick="disconnect();">Disconnect</button>
  <button type="button" onclick="reConnect();">Reconnect</button><br>
 </div>
 <div id="percent">Status: waiting for you to connect a device</div>
 <div id="tempHumiData">Temp/Humidity: waiting for data after connecting</div><hr>
 <div id="MAC"></div>
 <div>
	<hr>
	<div id="ldfile" hidden="true">
		Select Firmware: <input type="file" accept=".bin" id="file"/></div>
	<div id="ldfrmw"></div>
 </div>
  <div id="custcfg"></div>
  <hr>
  <button type="button" onclick="clearLog();">Clear Log</button>
  <div id="log"></div>

</body></html>

